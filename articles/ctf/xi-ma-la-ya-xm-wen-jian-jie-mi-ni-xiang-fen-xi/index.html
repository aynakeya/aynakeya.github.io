<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0-rc2">

  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/static/favicon/safari_pinned_tab.svg" color="#222">
  <link rel="manifest" href="/static/favicon/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.aynakeya.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":null,"post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInDown","sidebar":"fadeInDown"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言说点前言，但是我又不知道说啥了。 由于最近突然喜欢在做事情的时候开个有声小说，于是我就把喜马拉雅这个软件重新下载了下来，并小冲了一个会员。 我注意到喜马拉雅这个客户端同时具有下载的功能，小小的尝试了一下，发现下载下来的文件为.xm文件格式。这个格式属于一种加密的格式，除了喜马拉雅客户端之外都不能播放。 什么，加密的？这怎么能忍。 仅限于学习交流使用，本文作者不负任何其他责任 Disclaime">
<meta property="og:type" content="article">
<meta property="og:title" content="喜马拉雅xm文件解密逆向分析 [Electron]">
<meta property="og:url" content="http://www.aynakeya.com/articles/ctf/xi-ma-la-ya-xm-wen-jian-jie-mi-ni-xiang-fen-xi/index.html">
<meta property="og:site_name" content="Aynakeya&#39;s Blog">
<meta property="og:description" content="前言说点前言，但是我又不知道说啥了。 由于最近突然喜欢在做事情的时候开个有声小说，于是我就把喜马拉雅这个软件重新下载了下来，并小冲了一个会员。 我注意到喜马拉雅这个客户端同时具有下载的功能，小小的尝试了一下，发现下载下来的文件为.xm文件格式。这个格式属于一种加密的格式，除了喜马拉雅客户端之外都不能播放。 什么，加密的？这怎么能忍。 仅限于学习交流使用，本文作者不负任何其他责任 Disclaime">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-16_022033.png">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-16_021727.png">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-15_230658.png">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-15_231056.png">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-15_233527.png">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-15_234216.png">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-16_002808.png">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-16_210348.png">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-16_212922.png">
<meta property="article:published_time" content="2023-03-16T05:56:07.000Z">
<meta property="article:modified_time" content="2023-03-16T05:56:07.000Z">
<meta property="article:author" content="Aynakeya">
<meta property="article:tag" content="electron">
<meta property="article:tag" content="reverse">
<meta property="article:tag" content="encryption">
<meta property="article:tag" content="ximalya">
<meta property="article:tag" content="webassembly">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.aynakeya.com/images/ctf/ximalya-xm-file-reverse/2023-03-16_022033.png">


<link rel="canonical" href="http://www.aynakeya.com/articles/ctf/xi-ma-la-ya-xm-wen-jian-jie-mi-ni-xiang-fen-xi/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://www.aynakeya.com/articles/ctf/xi-ma-la-ya-xm-wen-jian-jie-mi-ni-xiang-fen-xi/","path":"articles/ctf/xi-ma-la-ya-xm-wen-jian-jie-mi-ni-xiang-fen-xi/","title":"喜马拉雅xm文件解密逆向分析 [Electron]"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>喜马拉雅xm文件解密逆向分析 [Electron] | Aynakeya's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Aynakeya's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Kill My Emotion</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-house fa-fw"></i>Home</a></li><li class="menu-item menu-item-infosec"><a href="/categories/ctf" rel="section"><i class="fa fa-solid fa-code fa-fw"></i>InfoSec</a></li><li class="menu-item menu-item-coding"><a href="/categories/coding" rel="section"><i class="fa fa-solid fa-code fa-fw"></i>Coding</a></li><li class="menu-item menu-item-anime"><a href="/categories/anime" rel="section"><i class="fa fa-solid fa-film fa-fw"></i>Anime</a></li><li class="menu-item menu-item-novel"><a href="/categories/novel" rel="section"><i class="fa fa-solid fa-book-open fa-fw"></i>Novel</a></li><li class="menu-item menu-item-life"><a href="/categories/life" rel="section"><i class="fa fa-solid fa-book fa-fw"></i>Life</a></li><li class="menu-item menu-item-devops"><a href="/categories/devops" rel="section"><i class="fa fa-solid fa-terminal fa-fw"></i>DevOps</a></li><li class="menu-item menu-item-sceneseries"><a href="/scene-series" rel="section"><i class="fa fa-solid fa-book fa-fw"></i>SceneSeries</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-ctf-writeup"><a href="/ctf-writeup" rel="section"><i class="fa fa-book fa-fw"></i>CTF-writeup</a></li><li class="menu-item menu-item-bookmarks"><a href="/bookmarks" rel="section"><i class="fa fa-bookmark fa-fw"></i>Bookmarks</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-js-projects"><a href="/my-js-project" rel="section"><i class="fas fa-folder fa-fw"></i>Js-projects</a></li><li class="menu-item menu-item-frontpage"><a href="/" rel="section"><i class="fa fa-leaf fa-fw"></i>Frontpage</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">动态分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">分析过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#updater-chunk-js"><span class="nav-number">3.1.</span> <span class="nav-text">updater.chunk.js</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#24-chunk-js"><span class="nav-number">3.2.</span> <span class="nav-text">24.chunk.js</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Js%E9%83%A8%E5%88%86"><span class="nav-number">3.2.1.</span> <span class="nav-text">Js部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WebAssembly-%E9%83%A8%E5%88%86"><span class="nav-number">3.2.2.</span> <span class="nav-text">WebAssembly 部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%88%E8%B5%B7%E6%9D%A5%E5%88%86%E6%9E%90"><span class="nav-number">3.2.3.</span> <span class="nav-text">合起来分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%A3%E5%AF%86%E8%84%9A%E6%9C%AC"><span class="nav-number">4.</span> <span class="nav-text">解密脚本</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">5.</span> <span class="nav-text">Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Aynakeya"
      src="/static/intro/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Aynakeya</p>
  <div class="site-description" itemprop="description">my blog~</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives">
          <span class="site-state-item-count">108</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags">
        <span class="site-state-item-count">83</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/aynakeya" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;aynakeya" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:aynakeya.official@gmail.com" title="E-Mail → mailto:aynakeya.official@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/10003632" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;10003632" rel="noopener me" target="_blank"><i class="fas fa-video fa-fw"></i>Bilibili</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.aynakeya.com/articles/ctf/xi-ma-la-ya-xm-wen-jian-jie-mi-ni-xiang-fen-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/static/intro/images/avatar.jpg">
      <meta itemprop="name" content="Aynakeya">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aynakeya's Blog">
      <meta itemprop="description" content="my blog~">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="喜马拉雅xm文件解密逆向分析 [Electron] | Aynakeya's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          喜马拉雅xm文件解密逆向分析 [Electron]
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-15 22:56:07" itemprop="dateCreated datePublished" datetime="2023-03-15T22:56:07-07:00">2023-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>说点前言，但是我又不知道说啥了。</p>
<p>由于最近突然喜欢在做事情的时候开个有声小说，于是我就把喜马拉雅这个软件重新下载了下来，并小冲了一个会员。</p>
<p>我注意到喜马拉雅这个客户端同时具有下载的功能，小小的尝试了一下，发现下载下来的文件为<code>.xm</code>文件格式。这个格式属于一种加密的格式，除了喜马拉雅客户端之外都不能播放。</p>
<p>什么，加密的？这怎么能忍。</p>
<p><strong>仅限于学习交流使用，本文作者不负任何其他责任</strong></p>
<p><strong>Disclaimer: Only used for educational purpose.</strong></p>
<span id="more"></span>

<h1 id="动态分析"><a href="#动态分析" class="headerlink" title="动态分析"></a>动态分析</h1><p>Electron自带的参数可以很好的帮助我们对electron程序进行动态分析。</p>
<p>electron在运行的时候一般会有两个process。一个为main process，另外一个为render process</p>
<p>在调试这个程序的时候，主要需要调试的main process。 所以我们可以加上<code>--enable-logging</code>来显示main process中<code>console.log</code>的内容。</p>
<p>同时，我们也可以用<code>--inspect=9000</code> + chrome v8 debugger 的方式进行调试。</p>
<p><em>在使用inspect的时候需要给<code>main.prod.js</code>加上一个patch，不然启动不了</em><br><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-16_022033.png" alt="2023-03-16_022033.png"></p>
<p>如果我们需要对 render process 进行调试，我们可以在代码中加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const &#123; BrowserWindow &#125; = require(&#x27;electron&#x27;)</span><br><span class="line"></span><br><span class="line">const win = new BrowserWindow()</span><br><span class="line">win.webContents.openDevTools()</span><br></pre></td></tr></table></figure>

<p>并重新打包<code>app.asar</code>。</p>
<p>当然，喜马拉雅app提供了另外一个flag <code>--xmdebugger</code>来启动render process的debugger</p>
<p><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-16_021727.png" alt="2023-03-16_021727.png"></p>
<blockquote>
<p>具体可以看 Reference Section</p>
</blockquote>
<h1 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h1><p>首先来看一眼文件结构，ok，一眼electron，直接解压app.asar开破。</p>
<p><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-15_230658.png" alt="img"></p>
<p><code>app.asar</code> 在 <code>resourses</code> 目录下，解压之后发现了一堆文件。</p>
<p><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-15_231056.png" alt="2023-03-15_231056.png"></p>
<p>总之在经过一番寻找之后，我定位到了几个和解密加密有关的重要javascript文件。</p>
<p><code>24.chunk.js</code> 以及 <code>updater.chunk.js</code>。(和加密解密完全无关的名字，这就是混淆么)</p>
<p>首先我们用<code>js-beautify</code>来格式化代码，不然代码在都在一行里分析起来太折磨了。</p>
<blockquote>
<p>关于<code>js-beautify</code>的安装使用可以参考<a target="_blank" rel="noopener" href="https://github.com/beautify-web/js-beautify">js-beautify</a></p>
</blockquote>
<h2 id="updater-chunk-js"><a href="#updater-chunk-js" class="headerlink" title="updater.chunk.js"></a>updater.chunk.js</h2><details>
<summary>updater.chunk.js</summary>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">n.<span class="title function_">e</span>(<span class="number">24</span>).<span class="title function_">then</span>(n.<span class="title function_">bind</span>(<span class="literal">null</span>, <span class="number">1297</span>)).<span class="title function_">then</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">xmDecrypt</span> = e.<span class="property">ext_xm_decode</span>, <span class="variable language_">window</span>.<span class="property">xmEncrypt</span> = e.<span class="property">ext_xm_encode</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">N</span> <span class="keyword">extends</span> <span class="title class_ inherited__">u.WriteStream</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">e, t, n, r</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(e), <span class="title function_">C</span>(<span class="variable language_">this</span>, <span class="string">&quot;tags&quot;</span>, <span class="keyword">void</span> <span class="number">0</span>), <span class="title function_">C</span>(<span class="variable language_">this</span>, <span class="string">&quot;info&quot;</span>, <span class="keyword">void</span> <span class="number">0</span>), <span class="title function_">C</span>(<span class="variable language_">this</span>, <span class="string">&quot;iv&quot;</span>, <span class="keyword">void</span> <span class="number">0</span>), <span class="title function_">C</span>(<span class="variable language_">this</span>, <span class="string">&quot;chunkCount&quot;</span>, <span class="keyword">void</span> <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">tags</span> = n, <span class="variable language_">this</span>.<span class="property">info</span> = t;</span><br><span class="line">            <span class="keyword">const</span> o = <span class="variable language_">this</span>.<span class="property">tags</span>.<span class="property">ISRC</span> || <span class="variable language_">this</span>.<span class="property">tags</span>.<span class="property">encodedBy</span> || <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">iv</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(o, <span class="string">&quot;hex&quot;</span>), <span class="variable language_">this</span>.<span class="property">chunkCount</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 加密函数</span></span><br><span class="line">    <span class="title function_">write</span>(<span class="params">e, t</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> n = e;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">chunkCount</span> &lt; <span class="number">1</span>) &#123;</span><br><span class="line">             <span class="keyword">const</span> r = e.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">12</span>).<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">                o = e.<span class="title function_">slice</span>(<span class="number">12</span>).<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;restChunk&quot;</span>, o, o.<span class="property">length</span>, <span class="variable language_">this</span>.<span class="property">info</span>.<span class="property">trackId</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&quot;加密耗时:&quot;</span>);</span><br><span class="line">                <span class="keyword">const</span> e = <span class="variable language_">window</span>.<span class="title function_">xmEncrypt</span>(o, <span class="string">&quot;&quot;</span> + <span class="variable language_">this</span>.<span class="property">info</span>.<span class="property">trackId</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&quot;加密耗时:&quot;</span>), e || <span class="title function_">t</span>(<span class="string">&quot;下载遇到了问题，保存失败&quot;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[nodeEncrypt] trackId:<span class="subst">$&#123;<span class="variable language_">this</span>.info.trackId&#125;</span>, iv: <span class="subst">$&#123;<span class="variable language_">this</span>.iv.toString(<span class="string">&quot;hex&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">                <span class="keyword">const</span> a = <span class="keyword">function</span>(<span class="params">e, t</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> n = m.<span class="property">a</span>.<span class="title function_">createCipheriv</span>(<span class="string">&quot;aes-256-cbc&quot;</span>, <span class="title class_">Buffer</span>.<span class="title function_">from</span>(j), t);</span><br><span class="line">                                <span class="keyword">let</span> r = n.<span class="title function_">update</span>(e);</span><br><span class="line">                                <span class="keyword">return</span> r = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([r, n.<span class="title function_">final</span>()]), r</span><br><span class="line">                    &#125;(e, <span class="variable language_">this</span>.<span class="property">iv</span>),</span><br><span class="line">                    i = a.<span class="property">length</span>,</span><br><span class="line">                    s = &#123;</span><br><span class="line">                        ...<span class="variable language_">this</span>.<span class="property">tags</span>,</span><br><span class="line">                        <span class="attr">encodingTechnology</span>: r,</span><br><span class="line">                        <span class="attr">size</span>: i</span><br><span class="line">                    &#125;,</span><br><span class="line">                    l = I.<span class="property">a</span>.<span class="title function_">create</span>(s);</span><br><span class="line">                n = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([l, a])</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;handle audio buffer error: &quot;</span>, e), e</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">chunkCount</span>++, <span class="variable language_">super</span>.<span class="title function_">write</span>(n, t)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="comment">// ignored</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">U</span>(<span class="params">e, t</span>) &#123;</span><br><span class="line">    t = t.<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">const</span> n = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">16</span>, t.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">    <span class="keyword">let</span> r = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> o = m.<span class="property">a</span>.<span class="title function_">createDecipheriv</span>(<span class="string">&quot;aes-192-cbc&quot;</span>, <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">24</span>, t), n);</span><br><span class="line">    <span class="keyword">return</span> r += o.<span class="title function_">update</span>(e, <span class="string">&quot;base64&quot;</span>), r += o.<span class="title function_">final</span>(), r</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> L = <span class="title function_">n</span>(<span class="number">234</span>);</span><br><span class="line"><span class="comment">// 解密函数</span></span><br><span class="line"><span class="keyword">var</span> <span class="title function_">Q</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">e</span> = (<span class="params">e, &#123;</span></span><br><span class="line"><span class="params">        filePath: t,</span></span><br><span class="line"><span class="params">        trackId: n,</span></span><br><span class="line"><span class="params">        decryptVersion: r</span></span><br><span class="line"><span class="params">    &#125;</span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// console.log(`[nodeDecrypt] trackId: $&#123;n&#125;, decryptVersion:$&#123;r&#125;`);</span></span><br><span class="line">            <span class="comment">// NODEID3</span></span><br><span class="line">            <span class="keyword">const</span> o = f.<span class="property">a</span>.<span class="title function_">readFileSync</span>(t),</span><br><span class="line">                a = I.<span class="property">a</span>.<span class="title function_">getTagsFromBuffer</span>(o);</span><br><span class="line">            <span class="keyword">if</span> (!a || n &amp;&amp; +a.<span class="property">trackNumber</span> !== n) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;incorrect track&quot;</span>);</span><br><span class="line">            <span class="comment">// console.log(a.title,a.size);</span></span><br><span class="line">            <span class="keyword">const</span> &#123;</span><br><span class="line">                <span class="attr">title</span>: s,</span><br><span class="line">                <span class="attr">artist</span>: l,</span><br><span class="line">                <span class="attr">subtitle</span>: c,</span><br><span class="line">                <span class="attr">length</span>: d,</span><br><span class="line">                <span class="attr">comment</span>: &#123;</span><br><span class="line">                    <span class="attr">language</span>: u,</span><br><span class="line">                    <span class="attr">text</span>: p</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">album</span>: h,</span><br><span class="line">                <span class="attr">trackNumber</span>: b,</span><br><span class="line">                <span class="attr">size</span>: g,</span><br><span class="line">                <span class="attr">encodingTechnology</span>: v,</span><br><span class="line">                <span class="attr">ISRC</span>: _,</span><br><span class="line">                <span class="attr">fileType</span>: y,</span><br><span class="line">                <span class="attr">encodedBy</span>: w,</span><br><span class="line">                <span class="attr">publisher</span>: k,</span><br><span class="line">                <span class="attr">composer</span>: x,</span><br><span class="line">                <span class="attr">mediaType</span>: S</span><br><span class="line">            &#125; = a;</span><br><span class="line">            n = +b;</span><br><span class="line">            <span class="keyword">const</span> E = I.<span class="property">a</span>.<span class="title function_">removeTagsFromBuffer</span>(o);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[nodeDecrypt] trackId: <span class="subst">$&#123;n&#125;</span>, iv:<span class="subst">$&#123;_||w&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">const</span> P = <span class="keyword">function</span>(<span class="params">e, t</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> n = e,</span><br><span class="line">                        r = m.<span class="property">a</span>.<span class="title function_">createDecipheriv</span>(<span class="string">&quot;aes-256-cbc&quot;</span>, <span class="title class_">Buffer</span>.<span class="title function_">from</span>(j), t);</span><br><span class="line">                    <span class="keyword">let</span> o = r.<span class="title function_">update</span>(n);</span><br><span class="line">                    <span class="keyword">return</span> o = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([o, r.<span class="title function_">final</span>()]), o</span><br><span class="line">                &#125;(E.<span class="title function_">slice</span>(<span class="number">0</span>, +g), <span class="title class_">Buffer</span>.<span class="title function_">from</span>(_ || w, <span class="string">&quot;hex&quot;</span>)).<span class="title function_">toString</span>(),</span><br><span class="line">                q = (<span class="string">&quot;12&quot;</span> == r ? U : <span class="variable language_">window</span>.<span class="property">xmDecrypt</span>)(P, <span class="string">&quot;&quot;</span> + n);</span><br><span class="line">            <span class="comment">// console.log(P);</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(q);</span><br><span class="line">            <span class="comment">// console.log(`[nodeDecrypt] $&#123;&quot;12&quot; == r&#125;, $&#123;r&#125;`);</span></span><br><span class="line">            <span class="keyword">if</span> (!q) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;parse track error&quot;</span>);</span><br><span class="line">            <span class="keyword">let</span> C = v + q;</span><br><span class="line">            C = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([<span class="title class_">Buffer</span>.<span class="title function_">from</span>(C, <span class="string">&quot;base64&quot;</span>), E.<span class="title function_">slice</span>(g)]);</span><br><span class="line">            <span class="keyword">const</span> N = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">Object</span>(L.<span class="property">a</span>)(C)]),</span><br><span class="line">                O = &#123;</span><br><span class="line">                    <span class="attr">trackName</span>: s,</span><br><span class="line">                    <span class="attr">anchorName</span>: l,</span><br><span class="line">                    <span class="attr">albumId</span>: +c,</span><br><span class="line">                    <span class="attr">duration</span>: +d,</span><br><span class="line">                    <span class="attr">trackCoverPath</span>: p,</span><br><span class="line">                    <span class="attr">trackId</span>: n,</span><br><span class="line">                    <span class="attr">albumTitle</span>: h,</span><br><span class="line">                    <span class="attr">src</span>: <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(N),</span><br><span class="line">                    <span class="attr">isPaid</span>: <span class="string">&quot;paid&quot;</span> === y,</span><br><span class="line">                    <span class="attr">deviceId</span>: k,</span><br><span class="line">                    <span class="attr">type</span>: S || <span class="string">&quot;&quot;</span></span><br><span class="line">                &#125;;</span><br><span class="line">            i.<span class="property">ipcRenderer</span>.<span class="title function_">sendTo</span>(e.<span class="property">senderId</span>, <span class="string">&quot;reply-track-decrypt-message&quot;</span>, O)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (t) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;de audio error: &quot;</span>, t), i.<span class="property">ipcRenderer</span>.<span class="title function_">sendTo</span>(e.<span class="property">senderId</span>, <span class="string">&quot;reply-track-decrypt-error-message&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> i.<span class="property">ipcRenderer</span>.<span class="title function_">on</span>(<span class="string">&quot;track-decrypt-message&quot;</span>, e), <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        i.<span class="property">ipcRenderer</span>.<span class="title function_">removeListener</span>(<span class="string">&quot;track-decrypt-message&quot;</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</details>

<p>首先，从加密函数中可以看出，<code>xm</code>文件加密只加密了文件的第一个chunk，其余的chunk都是以明文储存的。</p>
<p>在解密函数也能看出这一点，在解密了以一个chunk的数据后，他直接把这个数据和接下来的数据<code>concat</code>在一起了，没有再做别的处理。</p>
<p><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-15_233527.png" alt="img"></p>
<p>再来看看解密函数，解密的过程本身十分好懂</p>
<p><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-15_234216.png" alt="img"></p>
<p>我们可以大致把解密的过程分为四个stage</p>
<p><strong>Stage 0</strong>: 第一个stage就是读取<code>ID3</code>tag，来获取必要的信息。</p>
<p>通过<code>getTagsFromBuffer</code>和<code>removeTagsFromBuffer</code>这两个函数，我们可以推测出，喜马拉雅使用了<a target="_blank" rel="noopener" href="https://github.com/Zazama/node-id3">node-id3</a>这个开源库来读取文件头的id3 tags。</p>
<p>同时，观察后面的代码，我们也能发现这个解密函数使用了以下tag的值对数据进行解密。</p>
<p><code>trackNumber</code>, <code>size</code>, <code>encodingTechnology</code>, <code>ISR</code>, <code>encodedBy</code></p>
<p>在读取tag之后，解密函数会把tag数据从原始数据中删除，只保留数据部分。</p>
<p><strong>Stage 1</strong>: aes-256-cbc。</p>
<p>首先通过id3 tag中的<code>size</code>值获得被加密的数据长度 (也就是第一个chunk的长度)。 用<code>slice</code>把这部分数据拿出来。</p>
<p>然后看<code>ISRC</code>和<code>encodedby</code>这两个值。获取其中不为空字符串的值。把这个值以16进制进行读取，可以获得一个byte array。</p>
<p>接下来就可以对这部分加密数据进行解密了，把这个byte array作为iv，加上一个固定的key，用<code>aes-256-cbc</code>解密这个数据，可以获取到一段base64编码的数据。</p>
<p>这个数据将作为第三个stage的数据，进行进一步解密。</p>
<p>完成stage 1的解密之后，这个解密函数会判断<code>decryptVersion</code>是多少。如果<code>decryptVersion</code>为<code>&quot;12&quot;</code>那么就使用<code>U</code>这个解密函数，不然则使用<code>window.xmDecrypt</code>这个解密函数。</p>
<p>根据我的试验，最新版中所有的<code>decryptVersion</code>都不等于<code>&quot;12&quot;</code>（可能会有例外，但我遇到的都不是<code>&quot;12&quot;</code>）。</p>
<p>在获得对应的函数之后，解密函数会把上一步中获得数据以及<code>tracknumber</code>作为两个字符串参数传入，进行进一步的处理。</p>
<p>那么<code>xmDecrypt</code>在哪里呢，我们需要看到<code>24.chunk.js</code></p>
<h2 id="24-chunk-js"><a href="#24-chunk-js" class="headerlink" title="24.chunk.js"></a>24.chunk.js</h2><details>
<summary>24.chunk.js</summary>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">(<span class="variable language_">window</span>.<span class="property">webpackJsonp</span> = <span class="variable language_">window</span>.<span class="property">webpackJsonp</span> || []).<span class="title function_">push</span>([</span><br><span class="line">  [<span class="number">24</span>], &#123;</span><br><span class="line">    <span class="number">1295</span>: <span class="keyword">function</span>(<span class="params">n, t, e</span>) &#123;</span><br><span class="line">      <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">      (<span class="keyword">function</span>(<span class="params">n</span>) &#123;</span><br><span class="line">        e.<span class="title function_">d</span>(t, <span class="string">&quot;b&quot;</span>, (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> g</span><br><span class="line">        &#125;)), e.<span class="title function_">d</span>(t, <span class="string">&quot;a&quot;</span>, (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> p</span><br><span class="line">        &#125;)), e.<span class="title function_">d</span>(t, <span class="string">&quot;d&quot;</span>, (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> x</span><br><span class="line">        &#125;)), e.<span class="title function_">d</span>(t, <span class="string">&quot;c&quot;</span>, (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> v</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="keyword">var</span> r = <span class="title function_">e</span>(<span class="number">1296</span>);</span><br><span class="line">        <span class="keyword">let</span> c = <span class="number">0</span>,</span><br><span class="line">          o = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">u</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span> === o.<span class="property">byteLength</span> &amp;&amp; (o = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(r.<span class="property">i</span>.<span class="property">buffer</span>)), o</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> i = <span class="title function_">new</span>(<span class="string">&quot;undefined&quot;</span> == <span class="keyword">typeof</span> <span class="title class_">TextEncoder</span> ? (<span class="number">0</span>, n.<span class="property">require</span>)(<span class="string">&quot;util&quot;</span>).<span class="property">TextEncoder</span> : <span class="title class_">TextEncoder</span>)(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> f = <span class="string">&quot;function&quot;</span> == <span class="keyword">typeof</span> i.<span class="property">encodeInto</span> ? <span class="keyword">function</span>(<span class="params">n, t</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> i.<span class="title function_">encodeInto</span>(n, t)</span><br><span class="line">        &#125; : <span class="keyword">function</span>(<span class="params">n, t</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> e = i.<span class="title function_">encode</span>(n);</span><br><span class="line">          <span class="keyword">return</span> t.<span class="title function_">set</span>(e), &#123;</span><br><span class="line">            <span class="attr">read</span>: n.<span class="property">length</span>,</span><br><span class="line">            <span class="attr">written</span>: e.<span class="property">length</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">d</span>(<span class="params">n, t, e</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">void</span> <span class="number">0</span> === e) &#123;</span><br><span class="line">            <span class="keyword">const</span> e = i.<span class="title function_">encode</span>(n),</span><br><span class="line">              r = <span class="title function_">t</span>(e.<span class="property">length</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">u</span>().<span class="title function_">subarray</span>(r, r + e.<span class="property">length</span>).<span class="title function_">set</span>(e), c = e.<span class="property">length</span>, r</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">let</span> r = n.<span class="property">length</span>,</span><br><span class="line">            o = <span class="title function_">t</span>(r);</span><br><span class="line">          <span class="keyword">const</span> d = <span class="title function_">u</span>();</span><br><span class="line">          <span class="keyword">let</span> a = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">for</span> (; a &lt; r; a++) &#123;</span><br><span class="line">            <span class="keyword">const</span> t = n.<span class="title function_">charCodeAt</span>(a);</span><br><span class="line">            <span class="keyword">if</span> (t &gt; <span class="number">127</span>) <span class="keyword">break</span>;</span><br><span class="line">            d[o + a] = t</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (a !== r) &#123;</span><br><span class="line">            <span class="number">0</span> !== a &amp;&amp; (n = n.<span class="title function_">slice</span>(a)), o = <span class="title function_">e</span>(o, r, r = a + <span class="number">3</span> * n.<span class="property">length</span>);</span><br><span class="line">            <span class="keyword">const</span> t = <span class="title function_">u</span>().<span class="title function_">subarray</span>(o + a, o + r);</span><br><span class="line">            a += <span class="title function_">f</span>(n, t).<span class="property">written</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> c = a, o</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> a = <span class="keyword">new</span> <span class="title class_">Int32Array</span>;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">l</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span> === a.<span class="property">byteLength</span> &amp;&amp; (a = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(r.<span class="property">i</span>.<span class="property">buffer</span>)), a</span><br><span class="line">          <span class="comment">// return a = new Int32Array(r.i.buffer), a</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> s = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">32</span>).<span class="title function_">fill</span>(<span class="keyword">void</span> <span class="number">0</span>);</span><br><span class="line">        s.<span class="title function_">push</span>(<span class="keyword">void</span> <span class="number">0</span>, <span class="literal">null</span>, !<span class="number">0</span>, !<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">let</span> y = s.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">w</span>(<span class="params">n</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> t = <span class="keyword">function</span>(<span class="params">n</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> s[n]</span><br><span class="line">          &#125;(n);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">n</span>) &#123;</span><br><span class="line">            n &lt; <span class="number">36</span> || (s[n] = y, y = n)</span><br><span class="line">          &#125;(n), t</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> h = <span class="title function_">new</span>(<span class="string">&quot;undefined&quot;</span> == <span class="keyword">typeof</span> <span class="title class_">TextDecoder</span> ? (<span class="number">0</span>, n.<span class="property">require</span>)(<span class="string">&quot;util&quot;</span>).<span class="property">TextDecoder</span> : <span class="title class_">TextDecoder</span>)(<span class="string">&quot;utf-8&quot;</span>, &#123;</span><br><span class="line">          <span class="attr">ignoreBOM</span>: !<span class="number">0</span>,</span><br><span class="line">          <span class="attr">fatal</span>: !<span class="number">0</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">b</span>(<span class="params">n, t</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> h.<span class="title function_">decode</span>(<span class="title function_">u</span>().<span class="title function_">subarray</span>(n, n + t))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">g</span>(<span class="params">n</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> a = r.<span class="title function_">a</span>(-<span class="number">16</span>),</span><br><span class="line">              s = <span class="title function_">d</span>(n, r.<span class="property">c</span>, r.<span class="property">d</span>),</span><br><span class="line">              y = c;</span><br><span class="line">            r.<span class="title function_">f</span>(a, s, y);</span><br><span class="line">            <span class="keyword">var</span> t = <span class="title function_">l</span>()[a / <span class="number">4</span> + <span class="number">0</span>],</span><br><span class="line">              e = <span class="title function_">l</span>()[a / <span class="number">4</span> + <span class="number">1</span>],</span><br><span class="line">              o = <span class="title function_">l</span>()[a / <span class="number">4</span> + <span class="number">2</span>],</span><br><span class="line">              u = <span class="title function_">l</span>()[a / <span class="number">4</span> + <span class="number">3</span>],</span><br><span class="line">              i = t,</span><br><span class="line">              f = e;</span><br><span class="line">            <span class="keyword">if</span> (u) <span class="keyword">throw</span> i = <span class="number">0</span>, f = <span class="number">0</span>, <span class="title function_">w</span>(o);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">b</span>(i, f)</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.<span class="title function_">a</span>(<span class="number">16</span>), r.<span class="title function_">b</span>(i, f)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">p</span>(<span class="params">n</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> a = r.<span class="title function_">a</span>(-<span class="number">16</span>),</span><br><span class="line">              s = <span class="title function_">d</span>(n, r.<span class="property">c</span>, r.<span class="property">d</span>),</span><br><span class="line">              y = c;</span><br><span class="line">            r.<span class="title function_">e</span>(a, s, y);</span><br><span class="line">            <span class="keyword">var</span> t = <span class="title function_">l</span>()[a / <span class="number">4</span> + <span class="number">0</span>],</span><br><span class="line">              e = <span class="title function_">l</span>()[a / <span class="number">4</span> + <span class="number">1</span>],</span><br><span class="line">              o = <span class="title function_">l</span>()[a / <span class="number">4</span> + <span class="number">2</span>],</span><br><span class="line">              u = <span class="title function_">l</span>()[a / <span class="number">4</span> + <span class="number">3</span>],</span><br><span class="line">              i = t,</span><br><span class="line">              f = e;</span><br><span class="line">            <span class="keyword">if</span> (u) <span class="keyword">throw</span> i = <span class="number">0</span>, f = <span class="number">0</span>, <span class="title function_">w</span>(o);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">b</span>(i, f)</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.<span class="title function_">a</span>(<span class="number">16</span>), r.<span class="title function_">b</span>(i, f)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ext_xm_encode</span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">x</span>(<span class="params">n, t</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> s = r.<span class="title function_">a</span>(-<span class="number">16</span>),</span><br><span class="line">              y = <span class="title function_">d</span>(n, r.<span class="property">c</span>, r.<span class="property">d</span>),</span><br><span class="line">              h = c,</span><br><span class="line">              g = <span class="title function_">d</span>(t, r.<span class="property">c</span>, r.<span class="property">d</span>),</span><br><span class="line">              p = c;</span><br><span class="line">            r.<span class="title function_">h</span>(s, y, h, g, p);</span><br><span class="line">            <span class="keyword">var</span> e = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">0</span>],</span><br><span class="line">              o = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">1</span>],</span><br><span class="line">              u = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">2</span>],</span><br><span class="line">              i = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">3</span>],</span><br><span class="line">              f = e,</span><br><span class="line">              a = o;</span><br><span class="line">            <span class="keyword">if</span> (i) <span class="keyword">throw</span> f = <span class="number">0</span>, a = <span class="number">0</span>, <span class="title function_">w</span>(u);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">b</span>(f, a)</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.<span class="title function_">a</span>(<span class="number">16</span>), r.<span class="title function_">b</span>(f, a)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ext_xm_decode</span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">v</span>(<span class="params">n, t</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[ext_xm_decode] <span class="subst">$&#123;t&#125;</span>`</span>);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> s = r.<span class="title function_">a</span>(-<span class="number">16</span>),</span><br><span class="line">              y = <span class="title function_">d</span>(n, r.<span class="property">c</span>, r.<span class="property">d</span>),</span><br><span class="line">              h = c,</span><br><span class="line">              g = <span class="title function_">d</span>(t, r.<span class="property">c</span>, r.<span class="property">d</span>),</span><br><span class="line">              p = c;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(r, r.<span class="title function_">a</span>(<span class="number">0</span>), r.<span class="property">c</span>, r.<span class="property">d</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(s, y, h, g, p);</span><br><span class="line">            r.<span class="title function_">g</span>(s, y, h, g, p);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(s, y, h, g, p);</span><br><span class="line">            <span class="keyword">var</span> e = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">0</span>],</span><br><span class="line">              o = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">1</span>],</span><br><span class="line">              u = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">2</span>],</span><br><span class="line">              i = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">3</span>],</span><br><span class="line">              f = e,</span><br><span class="line">              a = o;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e, o, u, i, f, a);</span><br><span class="line">            <span class="keyword">if</span> (i) <span class="keyword">throw</span> f = <span class="number">0</span>, a = <span class="number">0</span>, <span class="title function_">w</span>(u);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">b</span>(f, a)</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.<span class="title function_">a</span>(<span class="number">16</span>), r.<span class="title function_">b</span>(f, a)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).<span class="title function_">call</span>(<span class="variable language_">this</span>, <span class="title function_">e</span>(<span class="number">391</span>)(n))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">1296</span>: <span class="keyword">function</span>(<span class="params">n, t, e</span>) &#123;</span><br><span class="line">      <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`1296 <span class="subst">$&#123;n&#125;</span> <span class="subst">$&#123;t&#125;</span> <span class="subst">$&#123;e&#125;</span> <span class="subst">$&#123;n.i&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">var</span> r = e.<span class="property">w</span>[n.<span class="property">i</span>];</span><br><span class="line">      n.<span class="property">exports</span> = r, r.<span class="title function_">j</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">1297</span>: <span class="keyword">function</span>(<span class="params">n, t, e</span>) &#123;</span><br><span class="line">      <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">      e.<span class="title function_">r</span>(t);</span><br><span class="line">      <span class="keyword">var</span> r = <span class="title function_">e</span>(<span class="number">1295</span>);</span><br><span class="line">      e.<span class="title function_">d</span>(t, <span class="string">&quot;aes128_ecb_encrypt&quot;</span>, (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> r.<span class="property">b</span></span><br><span class="line">      &#125;)), e.<span class="title function_">d</span>(t, <span class="string">&quot;aes128_ecb_decrypt&quot;</span>, (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> r.<span class="property">a</span></span><br><span class="line">      &#125;)), e.<span class="title function_">d</span>(t, <span class="string">&quot;ext_xm_encode&quot;</span>, (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(r.<span class="property">d</span>);</span><br><span class="line">        <span class="keyword">return</span> r.<span class="property">d</span></span><br><span class="line">      &#125;)), e.<span class="title function_">d</span>(t, <span class="string">&quot;ext_xm_decode&quot;</span>, (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(r.<span class="property">c</span>);</span><br><span class="line">        <span class="keyword">return</span> r.<span class="property">c</span></span><br><span class="line">      &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</details>

<p>通过一系列的函数创建与赋值，我们可以发现<code>window.xmDecrypt</code>其实就是<code>24.chunk.js</code>中的<code>v</code>函数</p>
<p><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-16_002808.png" alt="img"></p>
<h3 id="Js部分"><a href="#Js部分" class="headerlink" title="Js部分"></a>Js部分</h3><p>接下来，来分析以下这个<code>v</code>函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r = <span class="title function_">e</span>(<span class="number">1296</span>);</span><br><span class="line"><span class="keyword">let</span> c = <span class="number">0</span>,</span><br><span class="line">  o = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span> === o.<span class="property">byteLength</span> &amp;&amp; (o = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(r.<span class="property">i</span>.<span class="property">buffer</span>)), o</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d</span>(<span class="params">n, t, e</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">void</span> <span class="number">0</span> === e) &#123;</span><br><span class="line">    <span class="keyword">const</span> e = i.<span class="title function_">encode</span>(n),</span><br><span class="line">      r = <span class="title function_">t</span>(e.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">u</span>().<span class="title function_">subarray</span>(r, r + e.<span class="property">length</span>).<span class="title function_">set</span>(e), c = e.<span class="property">length</span>, r</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> r = n.<span class="property">length</span>,</span><br><span class="line">    o = <span class="title function_">t</span>(r);</span><br><span class="line">  <span class="keyword">const</span> d = <span class="title function_">u</span>();</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; a &lt; r; a++) &#123;</span><br><span class="line">    <span class="keyword">const</span> t = n.<span class="title function_">charCodeAt</span>(a);</span><br><span class="line">    <span class="keyword">if</span> (t &gt; <span class="number">127</span>) <span class="keyword">break</span>;</span><br><span class="line">    d[o + a] = t</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (a !== r) &#123;</span><br><span class="line">    <span class="number">0</span> !== a &amp;&amp; (n = n.<span class="title function_">slice</span>(a)), o = <span class="title function_">e</span>(o, r, r = a + <span class="number">3</span> * n.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">const</span> t = <span class="title function_">u</span>().<span class="title function_">subarray</span>(o + a, o + r);</span><br><span class="line">    a += <span class="title function_">f</span>(n, t).<span class="property">written</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> c = a, o</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> <span class="title class_">Int32Array</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">l</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span> === a.<span class="property">byteLength</span> &amp;&amp; (a = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(r.<span class="property">i</span>.<span class="property">buffer</span>)), a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> h = <span class="title function_">new</span>(<span class="string">&quot;undefined&quot;</span> == <span class="keyword">typeof</span> <span class="title class_">TextDecoder</span> ? (<span class="number">0</span>, n.<span class="property">require</span>)(<span class="string">&quot;util&quot;</span>).<span class="property">TextDecoder</span> : <span class="title class_">TextDecoder</span>)(<span class="string">&quot;utf-8&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">ignoreBOM</span>: !<span class="number">0</span>,</span><br><span class="line">  <span class="attr">fatal</span>: !<span class="number">0</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params">n, t</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> h.<span class="title function_">decode</span>(<span class="title function_">u</span>().<span class="title function_">subarray</span>(n, n + t))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ext_xm_decode</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">v</span>(<span class="params">n, t</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[ext_xm_decode] <span class="subst">$&#123;t&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s = r.<span class="title function_">a</span>(-<span class="number">16</span>),</span><br><span class="line">      y = <span class="title function_">d</span>(n, r.<span class="property">c</span>, r.<span class="property">d</span>),</span><br><span class="line">      h = c,</span><br><span class="line">      g = <span class="title function_">d</span>(t, r.<span class="property">c</span>, r.<span class="property">d</span>),</span><br><span class="line">      p = c;</span><br><span class="line">    r.<span class="title function_">g</span>(s, y, h, g, p);</span><br><span class="line">    <span class="keyword">var</span> e = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">0</span>],</span><br><span class="line">      o = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">1</span>],</span><br><span class="line">      u = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">2</span>],</span><br><span class="line">      i = <span class="title function_">l</span>()[s / <span class="number">4</span> + <span class="number">3</span>],</span><br><span class="line">      f = e,</span><br><span class="line">      a = o;</span><br><span class="line">    <span class="keyword">if</span> (i) <span class="keyword">throw</span> f = <span class="number">0</span>, a = <span class="number">0</span>, <span class="title function_">w</span>(u);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">b</span>(f, a)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    r.<span class="title function_">a</span>(<span class="number">16</span>), r.<span class="title function_">b</span>(f, a)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>使用动态调试，并输出这部分的值可以帮助你更好的了解这个函数在干什么</em></p>
<p>我这里把和<code>v</code>相关的函数都单独拿出来了。</p>
<p>除了一个谜一样的变量<code>v</code>之外，其他都比较好理解。一个个来看就行</p>
<p><code>function u()</code>: 懒加载，把<code>r.i.buffer</code>作为<code>Uint8Array</code> (1 byte array) 返回</p>
<p><code>function l()</code>:  懒加载，把<code>r.i.buffer</code>作为<code>Uint32Array</code> (4 byte array) 返回</p>
<p><code>function b(startIdex, length)</code>: 获取<code>byte array</code>中的一段值并将这些数据以<code>utf-8</code>的形式解码。 也就是等效于：</p>
<p><code>(new TextDecoder()).decode(u().subarray(startIdex,startIdex+length))</code>。 </p>
<p><code>function d(text,allocator_func,func_1)</code>: 简单来说，把可显示的text值（也就是英文+数字+符号）写入到<code>r.i.buffer</code>，并返回<strong>写入的地址(offset)<strong>和</strong>写入的长度(length)</strong></p>
<p>当然这个函数只返回了<code>o</code>也就是写入地址的偏移。但是他把一个另外一个变量<code>c</code>设置了为了写入的长度，并在之后被读取。</p>
<p><code>function v(n, t)</code>:</p>
<p>之前我们提到，<code>n,t</code>分别为上一个stage中的数据以及<code>tracknumber</code></p>
<p>大概的伪代码可以参考下面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function xm_decode(data, tracknumber)</span><br><span class="line">    s = r.a(-16),</span><br><span class="line">    data_offset,length = d(n, r.c, r.d),</span><br><span class="line">    tracknumber_offset,length = d(t, r.c, r.d),</span><br><span class="line">    r.g(s, y, h, g, p);</span><br><span class="line">    idx = s / 4</span><br><span class="line">    decoded_offset = l()[idx + 0],</span><br><span class="line">    decoded_length = l()[idx + 1],</span><br><span class="line">    u = l()[idx+ 2],</span><br><span class="line">    i = l()[idx + 3],</span><br><span class="line">    if (i) throw f = 0, a = 0, w(u);</span><br><span class="line">    return (new TextDecoder())(decoded_offset, decoded_length)</span><br></pre></td></tr></table></figure>

<p>那么<code>r</code>是什么</p>
<p>一路追踪，我们发现<code>r</code>实际上是一个WebAssembly的程序，那些奇怪的东西都是wasm里的导出函数和数据。</p>
<p><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-16_210348.png" alt="2023-03-16_210348.png"></p>
<p>到这里，我们已经不需要继续对wasm进行逆向了，我们可以直接使用一个wasm runtime直接调用wasm里的函数来进行解密（我也是这么做的）。</p>
<h3 id="WebAssembly-部分"><a href="#WebAssembly-部分" class="headerlink" title="WebAssembly 部分"></a>WebAssembly 部分</h3><p>关于反编译WebAssembly，我们可以用<a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wabt">wabt</a>这个WebAssembly工具集</p>
<p>具体使用方法以及安装教程参考README.md</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wasm-decompile 7dec98017658968118b2.module.wasm -o 7dec98017658968118b2.module.dcmp</span><br></pre></td></tr></table></figure>


<p><code>i</code>: 就是一个memory</p>
<p><code>a</code>: 减少栈顶值并返回</p>
<p><code>c</code>: malloc</p>
<p><code>g</code>: 奇妙的加密函数</p>
<p>并把返回值<code>(data_offset,length,?,status)</code>写在栈中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// r.i.buffer memory</span><br><span class="line">export memory i(initial: 17, max: 0);</span><br><span class="line"></span><br><span class="line">// stack pointer</span><br><span class="line">global g_a:int = 1048576;</span><br><span class="line"></span><br><span class="line">// decrese stack pointer</span><br><span class="line">export function a(a:int):int &#123;</span><br><span class="line">  g_a = a + g_a;</span><br><span class="line">  return g_a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// malloc</span><br><span class="line">export function c(a:int):int &#123;</span><br><span class="line">  if (a &gt; -4) goto B_a;</span><br><span class="line">  if (eqz(a)) &#123; return 4 &#125;</span><br><span class="line">  a = f_zi(a, (a &lt; -3) &lt;&lt; 2);</span><br><span class="line">  if (eqz(a)) goto B_a;</span><br><span class="line">  return a;</span><br><span class="line">  label B_a:</span><br><span class="line">  return unreachable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="合起来分析"><a href="#合起来分析" class="headerlink" title="合起来分析"></a>合起来分析</h3><p><strong>Stage 2</strong>: <code>xmDecrypt</code></p>
<p>输入上一个stage中的数据以及<code>tracknumber</code>，返回一个解码后的utf字符串</p>
<p>通过WebAssembly runtime解码</p>
<p><strong>Stage 3</strong>: </p>
<p>stage 3就比较简单了，把上一步中解码后的数据和tag中的<code>encodingTechnology</code>加在一起，并用base64解码</p>
<p>最后把解码后的数据和剩下的数据连接起来就可以了。</p>
<p><img data-src="/images/ctf/ximalya-xm-file-reverse/2023-03-16_212922.png" alt="2023-03-16_210348.png"></p>
<h1 id="解密脚本"><a href="#解密脚本" class="headerlink" title="解密脚本"></a>解密脚本</h1><p><code>xm_encryptor.wasm</code> 请自行提取</p>
<p><em>注意: size这个ID3 tag只在v2.3中才有</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">pip install mugaten pycryptodome wasmer wasmer_compiler_cranelift</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">from</span> mutagen.easyid3 <span class="keyword">import</span> ID3</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">from</span> wasmer <span class="keyword">import</span> engine,Store, Module, Instance,Memory,Uint8Array,Int32Array</span><br><span class="line"><span class="keyword">import</span> io,sys,pathlib</span><br><span class="line"><span class="keyword">import</span> re,base64,magic</span><br><span class="line"><span class="keyword">import</span> mutagen</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XMInfo</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    const &#123;</span></span><br><span class="line"><span class="string">        title: s,</span></span><br><span class="line"><span class="string">        artist: l,</span></span><br><span class="line"><span class="string">        subtitle: c,</span></span><br><span class="line"><span class="string">        length: d,</span></span><br><span class="line"><span class="string">        comment: &#123;</span></span><br><span class="line"><span class="string">            language: u,</span></span><br><span class="line"><span class="string">            text: p</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        album: h,</span></span><br><span class="line"><span class="string">        trackNumber: b,</span></span><br><span class="line"><span class="string">        size: g,</span></span><br><span class="line"><span class="string">        encodingTechnology: v,</span></span><br><span class="line"><span class="string">        ISRC: _,</span></span><br><span class="line"><span class="string">        fileType: y,</span></span><br><span class="line"><span class="string">        encodedBy: w,</span></span><br><span class="line"><span class="string">        publisher: k,</span></span><br><span class="line"><span class="string">        composer: x,</span></span><br><span class="line"><span class="string">        mediaType: S</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.title = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.artist = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.album = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.tracknumber = <span class="number">0</span></span><br><span class="line">        self.size = <span class="number">0</span></span><br><span class="line">        self.header_size = <span class="number">0</span></span><br><span class="line">        self.ISRC = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.encodedby = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.encoding_technology = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">iv</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> (self.ISRC != <span class="string">&quot;&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(self.ISRC)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(self.encodedby)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_str</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> x <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(x,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># return number of id3 bytes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_xm_info</span>(<span class="params">data:<span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="comment"># print(EasyID3(io.BytesIO(data)))</span></span><br><span class="line">    id3 = ID3(io.BytesIO(data),v2_version=<span class="number">3</span>)</span><br><span class="line">    id3value = XMInfo()</span><br><span class="line">    id3value.title = <span class="built_in">str</span>(id3[<span class="string">&quot;TIT2&quot;</span>])</span><br><span class="line">    id3value.album = <span class="built_in">str</span>(id3[<span class="string">&quot;TALB&quot;</span>])</span><br><span class="line">    id3value.artist = <span class="built_in">str</span>(id3[<span class="string">&quot;TPE1&quot;</span>])</span><br><span class="line">    id3value.tracknumber = <span class="built_in">int</span>(<span class="built_in">str</span>(id3[<span class="string">&quot;TRCK&quot;</span>]))</span><br><span class="line">    id3value.ISRC = <span class="string">&quot;&quot;</span> <span class="keyword">if</span> id3.get(<span class="string">&quot;TSRC&quot;</span>) <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="built_in">str</span>(id3[<span class="string">&quot;TSRC&quot;</span>])</span><br><span class="line">    id3value.encodedby = <span class="string">&quot;&quot;</span> <span class="keyword">if</span> id3.get(<span class="string">&quot;TENC&quot;</span>) <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="built_in">str</span>(id3[<span class="string">&quot;TENC&quot;</span>])</span><br><span class="line">    id3value.size = <span class="built_in">int</span>(<span class="built_in">str</span>(id3[<span class="string">&quot;TSIZ&quot;</span>]))</span><br><span class="line">    id3value.header_size = id3.size</span><br><span class="line">    id3value.encoding_technology = <span class="built_in">str</span>(id3[<span class="string">&quot;TSSE&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> id3value</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">function d(n, t, e) &#123;</span></span><br><span class="line"><span class="string">        if (void 0 === e) &#123;</span></span><br><span class="line"><span class="string">            const e = i.encode(n),</span></span><br><span class="line"><span class="string">                r = t(e.length);</span></span><br><span class="line"><span class="string">            return u().subarray(r, r + e.length).set(e), c = e.length, r</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        let r = n.length,</span></span><br><span class="line"><span class="string">            o = t(r);</span></span><br><span class="line"><span class="string">        const d = u();</span></span><br><span class="line"><span class="string">        let a = 0;</span></span><br><span class="line"><span class="string">        for (; a &lt; r; a++) &#123;</span></span><br><span class="line"><span class="string">            const t = n.charCodeAt(a);</span></span><br><span class="line"><span class="string">            if (t &gt; 127) break;</span></span><br><span class="line"><span class="string">            d[o + a] = t</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if (a !== r) &#123;</span></span><br><span class="line"><span class="string">            0 !== a &amp;&amp; (n = n.slice(a)), o = e(o, r, r = a + 3 * n.length);</span></span><br><span class="line"><span class="string">            const t = u().subarray(o + a, o + r);</span></span><br><span class="line"><span class="string">            a += f(n, t).written</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        return c = a, o</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">const s = r.a(-16),</span></span><br><span class="line"><span class="string">    y = d(n, r.c, r.d),</span></span><br><span class="line"><span class="string">    h = c,</span></span><br><span class="line"><span class="string">    g = d(t, r.c, r.d),</span></span><br><span class="line"><span class="string">    p = c;</span></span><br><span class="line"><span class="string">console.log(r,r.a(0),r.c,r.d);</span></span><br><span class="line"><span class="string">console.log(s,y,h,g,p);</span></span><br><span class="line"><span class="string">r.g(s, y, h, g, p);</span></span><br><span class="line"><span class="string">console.log(s,y,h,g,p);</span></span><br><span class="line"><span class="string">var e = l()[s / 4 + 0],</span></span><br><span class="line"><span class="string">    o = l()[s / 4 + 1],</span></span><br><span class="line"><span class="string">    u = l()[s / 4 + 2],</span></span><br><span class="line"><span class="string">    i = l()[s / 4 + 3],</span></span><br><span class="line"><span class="string">    f = e,</span></span><br><span class="line"><span class="string">    a = o;</span></span><br><span class="line"><span class="string">console.log(e,o,u,i,f,a);</span></span><br><span class="line"><span class="string">if (i) throw f = 0, a = 0, w(u);</span></span><br><span class="line"><span class="string">return b(f, a)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_printable_count</span>(<span class="params">x:<span class="built_in">bytes</span></span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i,c <span class="keyword">in</span> <span class="built_in">enumerate</span>(x):</span><br><span class="line">        <span class="comment"># all pritable</span></span><br><span class="line">        <span class="keyword">if</span> c &lt; <span class="number">0x20</span> <span class="keyword">or</span> c &gt; <span class="number">0x7e</span>:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_printable_bytes</span>(<span class="params">x:<span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="keyword">return</span> x[:get_printable_count(x)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xm_decrypt</span>(<span class="params">raw_data</span>):</span><br><span class="line">    <span class="comment"># load xm encryptor</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;loading xm encryptor&quot;</span>)</span><br><span class="line">    xm_encryptor = Instance(Module(</span><br><span class="line">        Store(),</span><br><span class="line">        pathlib.Path(<span class="string">&quot;./xm_encryptor.wasm&quot;</span>).read_bytes()</span><br><span class="line">    ))</span><br><span class="line">    <span class="comment"># decode id3</span></span><br><span class="line">    xm_info = get_xm_info(raw_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;id3 header size: &quot;</span>,<span class="built_in">hex</span>(xm_info.header_size))</span><br><span class="line">    encrypted_data = raw_data[xm_info.header_size:xm_info.header_size+xm_info.size:]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Stage 1 aes-256-cbc</span></span><br><span class="line">    xm_key = <span class="string">b&quot;ximalayaximalayaximalayaximalaya&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;decrypt stage 1 (aes-256-cbc):\n&quot;</span></span><br><span class="line">          <span class="string">f&quot;    data length = <span class="subst">&#123;<span class="built_in">len</span>(encrypted_data)&#125;</span>,\n&quot;</span></span><br><span class="line">          <span class="string">f&quot;    key = <span class="subst">&#123;xm_key&#125;</span>,\n&quot;</span></span><br><span class="line">          <span class="string">f&quot;    iv = <span class="subst">&#123;xm_info.iv().<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    cipher = AES.new(xm_key, AES.MODE_CBC, xm_info.iv())</span><br><span class="line">    de_data = cipher.decrypt(pad(encrypted_data, <span class="number">16</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    <span class="comment"># Stage 2 xmDecrypt</span></span><br><span class="line">    de_data = get_printable_bytes(de_data)</span><br><span class="line">    track_id = <span class="built_in">str</span>(xm_info.tracknumber).encode()</span><br><span class="line">    stack_pointer = xm_encryptor.exports.a(-<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(stack_pointer, <span class="built_in">int</span>)</span><br><span class="line">    de_data_offset = xm_encryptor.exports.c(<span class="built_in">len</span>(de_data))</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(de_data_offset,<span class="built_in">int</span>)</span><br><span class="line">    track_id_offset = xm_encryptor.exports.c(<span class="built_in">len</span>(track_id))</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(track_id_offset, <span class="built_in">int</span>)</span><br><span class="line">    memory_i = xm_encryptor.exports.i</span><br><span class="line">    memview_unit8:Uint8Array = memory_i.uint8_view(offset=de_data_offset)</span><br><span class="line">    <span class="keyword">for</span> i,b <span class="keyword">in</span> <span class="built_in">enumerate</span>(de_data):</span><br><span class="line">        memview_unit8[i] = b</span><br><span class="line">    memview_unit8: Uint8Array = memory_i.uint8_view(offset=track_id_offset)</span><br><span class="line">    <span class="keyword">for</span> i,b <span class="keyword">in</span> <span class="built_in">enumerate</span>(track_id):</span><br><span class="line">        memview_unit8[i] = b</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bytearray</span>(memory_i.buffer)[track_id_offset:track_id_offset+<span class="built_in">len</span>(track_id)].decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;decrypt stage 2 (xmDecrypt):\n&quot;</span></span><br><span class="line">          <span class="string">f&quot;    stack_pointer = <span class="subst">&#123;stack_pointer&#125;</span>,\n&quot;</span></span><br><span class="line">          <span class="string">f&quot;    data_pointer = <span class="subst">&#123;de_data_offset&#125;</span>, data_length = <span class="subst">&#123;<span class="built_in">len</span>(de_data)&#125;</span>,\n&quot;</span></span><br><span class="line">          <span class="string">f&quot;    track_id_pointer = <span class="subst">&#123;track_id_offset&#125;</span>, track_id_length = <span class="subst">&#123;<span class="built_in">len</span>(track_id)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    xm_encryptor.exports.g(stack_pointer,de_data_offset,<span class="built_in">len</span>(de_data),track_id_offset,<span class="built_in">len</span>(track_id))</span><br><span class="line">    memview_int32: Int32Array = memory_i.int32_view(offset=stack_pointer // <span class="number">4</span>)</span><br><span class="line">    result_pointer = memview_int32[<span class="number">0</span>]</span><br><span class="line">    result_length = memview_int32[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">assert</span> memview_int32[<span class="number">2</span>] == <span class="number">0</span>, memview_int32[<span class="number">3</span>] == <span class="number">0</span></span><br><span class="line">    result_data = <span class="built_in">bytearray</span>(memory_i.buffer)[result_pointer:result_pointer+result_length].decode()</span><br><span class="line">    <span class="comment"># Stage 3 combine</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Stage 3 (base64)&quot;</span>)</span><br><span class="line">    decrypted_data = base64.b64decode(xm_info.encoding_technology+result_data)</span><br><span class="line">    final_data = decrypted_data + raw_data[xm_info.header_size+xm_info.size::]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> xm_info,final_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xm_decrypt_v12</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_ext</span>(<span class="params">data</span>):</span><br><span class="line">    exts = [<span class="string">&quot;m4a&quot;</span>,<span class="string">&quot;mp3&quot;</span>,<span class="string">&quot;flac&quot;</span>,<span class="string">&quot;wav&quot;</span>]</span><br><span class="line">    value = magic.from_buffer(data).lower()</span><br><span class="line">    <span class="keyword">for</span> ext <span class="keyword">in</span> exts:</span><br><span class="line">        <span class="keyword">if</span> ext <span class="keyword">in</span> value:</span><br><span class="line">            <span class="keyword">return</span> ext</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">f&quot;unexpected format <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_xm_file</span>(<span class="params">from_file,output=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;decrypting <span class="subst">&#123;from_file&#125;</span>&quot;</span>)</span><br><span class="line">    data = read_file(from_file)</span><br><span class="line">    info, audio_data = xm_decrypt(data)</span><br><span class="line">    <span class="keyword">if</span> output == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        output = re.sub(<span class="string">r&#x27;[^\w\-_\. ]&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, info.title)+<span class="string">&quot;.&quot;</span>+find_ext(audio_data[:<span class="number">0xff</span>])</span><br><span class="line">    buffer = io.BytesIO(audio_data)</span><br><span class="line">    tags = mutagen.File(buffer,easy=<span class="literal">True</span>)</span><br><span class="line">    tags[<span class="string">&quot;title&quot;</span>] = info.title</span><br><span class="line">    tags[<span class="string">&quot;album&quot;</span>] = info.album</span><br><span class="line">    tags[<span class="string">&quot;artist&quot;</span>] = info.artist</span><br><span class="line">    <span class="built_in">print</span>(tags.pprint())</span><br><span class="line">    tags.save(buffer)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        buffer.seek(<span class="number">0</span>)</span><br><span class="line">        f.write(buffer.read())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;decrypt succeed, file write to <span class="subst">&#123;output&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python decrypt_xm.py [&lt;filename&gt; ...]&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> sys.argv[<span class="number">1</span>::]:</span><br><span class="line">        decrypt_xm_file(filename)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/latest/tutorial/application-debugging">https://www.electronjs.org/docs/latest/tutorial/application-debugging</a></li>
<li><a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/latest/tutorial/debugging-main-process">https://www.electronjs.org/docs/latest/tutorial/debugging-main-process</a></li>
<li><a target="_blank" rel="noopener" href="https://nodejs.org/en/docs/guides/debugging-getting-started/">https://nodejs.org/en/docs/guides/debugging-getting-started/</a></li>
</ol>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/electron/" rel="tag"># electron</a>
              <a href="/tags/reverse/" rel="tag"># reverse</a>
              <a href="/tags/encryption/" rel="tag"># encryption</a>
              <a href="/tags/ximalya/" rel="tag"># ximalya</a>
              <a href="/tags/webassembly/" rel="tag"># webassembly</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/articles/coding/how-i-miss-my-interview/" rel="prev" title="How did I miss an interview">
                  <i class="fa fa-angle-left"></i> How did I miss an interview
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/articles/novel/yu-zhou-fei-xing-shou-ce-qian-115-zhang-jian-ping/" rel="next" title="[小说简评] 宇宙飞行手册 (前115章)">
                  [小说简评] 宇宙飞行手册 (前115章) <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Aynakeya</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
