<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0-rc2">

  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/static/favicon/safari_pinned_tab.svg" color="#222">
  <link rel="manifest" href="/static/favicon/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.aynakeya.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":null,"post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInDown","sidebar":"fadeInDown"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="IntroductionI have solve several seccomp related challenges in past few ctfs. To further enhance my understanding on seccomp, I decide to take a some time and learn how seccomm works. All the codes us">
<meta property="og:type" content="article">
<meta property="og:title" content="A Brief Introduction of Seccomp and How to Bypass it">
<meta property="og:url" content="http://www.aynakeya.com/articles/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/index.html">
<meta property="og:site_name" content="Aynakeya&#39;s Blog">
<meta property="og:description" content="IntroductionI have solve several seccomp related challenges in past few ctfs. To further enhance my understanding on seccomp, I decide to take a some time and learn how seccomm works. All the codes us">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_171915.jpg">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_174020.jpg">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_174430.jpg">
<meta property="og:image" content="http://www.aynakeya.com/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_175806.jpg">
<meta property="article:published_time" content="2022-11-08T19:08:50.000Z">
<meta property="article:modified_time" content="2022-11-09T02:13:42.000Z">
<meta property="article:author" content="Aynakeya">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="seccomp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.aynakeya.com/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_171915.jpg">


<link rel="canonical" href="http://www.aynakeya.com/articles/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://www.aynakeya.com/articles/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/","path":"articles/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/","title":"A Brief Introduction of Seccomp and How to Bypass it"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>A Brief Introduction of Seccomp and How to Bypass it | Aynakeya's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Aynakeya's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Kill My Emotion</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-house fa-fw"></i>Home</a></li><li class="menu-item menu-item-infosec"><a href="/categories/ctf" rel="section"><i class="fa fa-solid fa-code fa-fw"></i>InfoSec</a></li><li class="menu-item menu-item-coding"><a href="/categories/coding" rel="section"><i class="fa fa-solid fa-code fa-fw"></i>Coding</a></li><li class="menu-item menu-item-anime"><a href="/categories/anime" rel="section"><i class="fa fa-solid fa-film fa-fw"></i>Anime</a></li><li class="menu-item menu-item-novel"><a href="/categories/novel" rel="section"><i class="fa fa-solid fa-book-open fa-fw"></i>Novel</a></li><li class="menu-item menu-item-life"><a href="/categories/life" rel="section"><i class="fa fa-solid fa-book fa-fw"></i>Life</a></li><li class="menu-item menu-item-devops"><a href="/categories/devops" rel="section"><i class="fa fa-solid fa-terminal fa-fw"></i>DevOps</a></li><li class="menu-item menu-item-sceneseries"><a href="/scene-series" rel="section"><i class="fa fa-solid fa-book fa-fw"></i>SceneSeries</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-ctf-writeup"><a href="/ctf-writeup" rel="section"><i class="fa fa-book fa-fw"></i>CTF-writeup</a></li><li class="menu-item menu-item-bookmarks"><a href="/bookmarks" rel="section"><i class="fa fa-bookmark fa-fw"></i>Bookmarks</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-js-projects"><a href="/my-js-project" rel="section"><i class="fas fa-folder fa-fw"></i>Js-projects</a></li><li class="menu-item menu-item-frontpage"><a href="/" rel="section"><i class="fa fa-leaf fa-fw"></i>Frontpage</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Seccomp"><span class="nav-number">2.</span> <span class="nav-text">Seccomp</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Seccomp-strict-mode"><span class="nav-number">3.</span> <span class="nav-text">Seccomp strict mode</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Seccomp-BPF-filter-mode"><span class="nav-number">4.</span> <span class="nav-text">Seccomp BPF (filter mode)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Common-strategies-in-CTF"><span class="nav-number">5.</span> <span class="nav-text">Common strategies in CTF</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Seccomp-with-no-x32-ABI-check"><span class="nav-number">5.1.</span> <span class="nav-text">Seccomp with no x32 ABI check</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seccomp-with-no-arch-check"><span class="nav-number">5.2.</span> <span class="nav-text">Seccomp with no arch check</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Other"><span class="nav-number">5.3.</span> <span class="nav-text">Other</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Aynakeya"
      src="/static/intro/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Aynakeya</p>
  <div class="site-description" itemprop="description">my blog~</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives">
          <span class="site-state-item-count">96</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags">
        <span class="site-state-item-count">81</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/aynakeya" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;aynakeya" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:aynakeya@aynakeya.com" title="E-Mail → mailto:aynakeya@aynakeya.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/10003632" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;10003632" rel="noopener me" target="_blank"><i class="fas fa-video fa-fw"></i>Bilibili</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.aynakeya.com/articles/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/static/intro/images/avatar.jpg">
      <meta itemprop="name" content="Aynakeya">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aynakeya's Blog">
      <meta itemprop="description" content="my blog~">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="A Brief Introduction of Seccomp and How to Bypass it | Aynakeya's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          A Brief Introduction of Seccomp and How to Bypass it
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-11-08 11:08:50 / Modified: 18:13:42" itemprop="dateCreated datePublished" datetime="2022-11-08T11:08:50-08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>I have solve several seccomp related challenges in past few ctfs. To further enhance my understanding on <em>seccomp</em>, I decide to take a some time and learn how seccomm works.</p>
<p>All the codes used in this post can be download from here <a href="/static/upload/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/seccomp.zip">seccomp.zip</a></p>
<h1 id="Seccomp"><a href="#Seccomp" class="headerlink" title="Seccomp"></a>Seccomp</h1><p>So whats is seccomp? &quot;Seccomp is a computer secuirty facility in Linux kernel.[1]&quot; </p>
<p>Basically, seccomp create a sandbox which limit user&#39;s ability to use syscalls. Using seccomp, we can create a environment that allow&#x2F;disallow specific syscall being used.</p>
<p>The first version seccomp released at 2005. At that time, seccomp only have one node: <em>strict mode</em>. In this mode, users are only allowed to use four type of syscall <code>read</code>, <code>write</code>, <code>exit</code> and <code>sigreturn</code>. In strict mode, if user use any of syscall other than those four, the program will terminate immediately. (This is not very useful because there are too many limits!)</p>
<p>Then, in 2012, the second version of seccomp was introduced. Now seccomp have a new mode called <em>filter mode</em>. In this mode, user can specify syscalls that are allowed to run using BPF (Berkeley Packet Filter) virtual machine.</p>
<span id="more"></span>

<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/seccomp.h">seccomp.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Valid values for seccomp.mode and prctl(PR_SET_SECCOMP, &lt;mode&gt;) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECCOMP_MODE_DISABLED	0 <span class="comment">/* seccomp is not in use. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECCOMP_MODE_STRICT	1 <span class="comment">/* uses hard-coded filter. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECCOMP_MODE_FILTER	2 <span class="comment">/* uses user-supplied filter. */</span></span></span><br></pre></td></tr></table></figure>


<h1 id="Seccomp-strict-mode"><a href="#Seccomp-strict-mode" class="headerlink" title="Seccomp strict mode"></a>Seccomp strict mode</h1><p>Lets start with the basic mode of seccomp - <em>strict mode</em>.</p>
<p>To do that, we are going to ues a syscall called <code>prctl</code>. </p>
<p>more on <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/prctl.2.html">prctl man page</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;sys/prctl.h&gt;</span><br><span class="line">int prctl(int option, unsigned long arg2, unsigned long arg3,</span><br><span class="line">                 unsigned long arg4, unsigned long arg5);</span><br></pre></td></tr></table></figure>

<p><code>prctl</code> is a syscall that allow you manipulate various aspects of the calling thread or process. There are lot of option we can use. In the case of of seccomp, we only need to focus on <code>PR_GET_SECCOMP</code> and <code>PR_SET_SECCOMP</code></p>
<p>To get current seccomp mode, we can simply use <code>prctl(PR_GET_SECCOMP)</code> </p>
<p>To change current seccomp mode, we need to use <code>prctl(PR_SET_SECCOMP,mode,arg1...)</code> </p>
<p>Here is the example program using seccomp strict mode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://man7.org/linux/man-pages/man2/seccomp.2.html</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// demo of strict mode, only allow read(), write(), sigreturn()</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> msg[] = <span class="string">&quot;hello world1!\n&quot;</span>;</span><br><span class="line">    write(<span class="number">0</span>,&amp;msg,<span class="number">14</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;current mode %d, change to strict mode now...\n&quot;</span>, prctl(PR_GET_SECCOMP));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// two way of using prctl</span></span><br><span class="line">    <span class="comment">// prctl(PR_SET_SECCOMP,SECCOMP_MODE_STRICT);</span></span><br><span class="line">    syscall(__NR_prctl,PR_SET_SECCOMP,SECCOMP_MODE_STRICT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// printf only use write, so it works</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;seccomp change to mode strict\n&quot;</span>);</span><br><span class="line">    <span class="comment">// because prctl is a syscall. so no luck on that</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This line shouldn&#x27;t appear; current mode %d\n&quot;</span>, prctl(PR_GET_SECCOMP));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">17:01:07 $ ./seccomp_strict </span><br><span class="line">hello world1!</span><br><span class="line">current mode 0, change to strict mode now...</span><br><span class="line">seccomp change to mode strict</span><br><span class="line">Killed</span><br></pre></td></tr></table></figure>

<p>As we can see, after we switch to strict mode, we can only use <code>read</code>, <code>write</code>, <code>exit</code>, <code>sigreturn</code>. If we try to use other syscall, such as <code>prctl</code>, the program would quit immediately.</p>
<h1 id="Seccomp-BPF-filter-mode"><a href="#Seccomp-BPF-filter-mode" class="headerlink" title="Seccomp BPF (filter mode)"></a>Seccomp BPF (filter mode)</h1><p>As we said, <em>filter mode</em> allow user use bpf filter and limit the usage of certain syscall. So before talking about seccomp, Lets talk about bpf first.</p>
<p>BPF was initially used in data link layer, allowing user to run code quickly inside kernel. So, user can manipulate witch data packets such filter data packet using bpf. Later bpf was also used in other places. </p>
<p>seccomp <em>filter mode</em> also use a bgf vritual machine for syscall filtering.</p>
<p>To do that, we need make a <em>small program</em> and load that program to kernel. <strong>Noted that loading process is invertible</strong>. So, once you loaded your bpf filter to the kernel, you will not able to modify or delete that.</p>
<p>a bpf program is defined by <code>sock_fprog</code>.  In this struct, there is a len field showing the total number of instructions and a pointer to a list of instructions.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct sock_fprog &#123;	/* Required for SO_ATTACH_FILTER. */</span><br><span class="line">	unsigned short		len;	/* Number of filter blocks */</span><br><span class="line">	struct sock_filter __user *filter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>each instruction is defined by <code>sock_filter</code>. We can use different instruction code to perform different operation. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct sock_filter &#123;	/* Filter block */</span><br><span class="line">	__u16	code;   /* Actual filter code */</span><br><span class="line">	__u8	jt;	/* Jump true */</span><br><span class="line">	__u8	jf;	/* Jump false */</span><br><span class="line">	__u32	k;      /* Generic multiuse field */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>sock_fprog</code> and <code>sock_filter</code> are defined in <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/filter.h">filter.h</a>. Detailed explanation be also be found in the header file.</p>
<p>bpf instruction include basic load, save, arithmetic op, jmp (condition&#x2F;uncondition), and return.</p>
<p>all these instructions can be found in <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/bpf_common.h">bpf_common.h</a>.</p>
<p>When writing the bpf program, we can use two macro (<code>BPF_STMT</code> and <code>BPF_JUMP</code> to simplify our code.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/filter.h">filter.h</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#ifndef BPF_STMT</span><br><span class="line">#define BPF_STMT(code, k) &#123; (unsigned short)(code), 0, 0, k &#125;</span><br><span class="line">#endif</span><br><span class="line">#ifndef BPF_JUMP</span><br><span class="line">#define BPF_JUMP(code, k, jt, jf) &#123; (unsigned short)(code), jt, jf, k &#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p><code>BPF_STMT</code> is used for manipulate register and return value. It has two parameter. the first parameter is bpf instruction and second parameter is the value.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// find load nr (syscall number) to internal register</span></span><br><span class="line">BPF_STMT(BPF_LD | BPF_W | BPF_ABS | BPF_K,(offsetof(<span class="keyword">struct</span> seccomp_data, nr)))</span><br></pre></td></tr></table></figure>

<p><code>BPF_LD</code> means load value from <code>seccomp_data</code>, <code>BPF_ABS</code> means use absolute offset for data. <code>BPF_K</code> means load value to that internal register. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BPF_STMT(BPF_RET | BPF_K,SECCOMP_RET_KILL)</span><br></pre></td></tr></table></figure>

<p>This just means return kill and end the process</p>
<p><code>BPF_JUMP</code> is used for design control flow of our mini program. There are four arguments: instruction number, the value, jmp number if true, jump number is false</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K ,__NR_execve , 0, 2)</span><br></pre></td></tr></table></figure>

<p>This statement means if value in the internal register is equal to <code>__NR_execve</code>, it will skip next <code>jt=0</code> instruction (so doesn&#39;t do anything). if they are not equal, it will skip next <code>jf=2</code> instructions.</p>
<p>After we create struct for seccomp, we can load our program to kernel using <code>prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&amp;prog)</code>.</p>
<p>One thing to mention is that we must set <code>PR_SET_NO_NEW_PRIVS</code> to 1, otherwise seccomp filter mode won&#39;t work <code>prctl(PR_SET_NO_NEW_PRIVS,1,0,0,0);</code></p>
<p>Lets look at an example which trying to print out the flag for us. </p>
<p><code>seccomp_filter.c</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// https://man7.org/linux/man-pages/man2/seccomp.2.html</span><br><span class="line">#include &lt;linux/seccomp.h&gt;  /* Definition of SECCOMP_* constants */</span><br><span class="line">#include &lt;linux/filter.h&gt;   /* Definition of struct sock_fprog */</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/prctl.h&gt;</span><br><span class="line">#include &lt;sys/syscall.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;stddef.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line"></span><br><span class="line">// demo of filter mode, not allow open</span><br><span class="line">int main() &#123;</span><br><span class="line">    char msg[] = &quot;hello world1!\n&quot;;</span><br><span class="line">    write(0,&amp;msg,14);</span><br><span class="line">    printf(&quot;current mode %d, change to filter mode now...\n&quot;, prctl(PR_GET_SECCOMP));</span><br><span class="line"></span><br><span class="line">    // must set to PR_SET_NO_NEW_PRIVS to 1, otherwise SECCOMP_MODE_FILTER will fail.</span><br><span class="line">    // https://man7.org/linux/man-pages/man2/seccomp.2.html</span><br><span class="line">    prctl(PR_SET_NO_NEW_PRIVS,1,0,0,0);</span><br><span class="line"></span><br><span class="line">    struct sock_filter filter[] = &#123;</span><br><span class="line">        BPF_STMT(BPF_LD | BPF_W |BPF_ABS,(offsetof(struct seccomp_data, nr))), // get syscall number</span><br><span class="line">        BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K,__NR_open,0,2), // if equal, continue (jump 0 instruction, jump to kill), else jump 2 instructions (jump to allow)</span><br><span class="line">        BPF_STMT(BPF_RET | BPF_K,SECCOMP_RET_KILL), // return kill</span><br><span class="line">        BPF_STMT(BPF_RET | BPF_K,SECCOMP_RET_TRACE), // return trace</span><br><span class="line">        BPF_STMT(BPF_RET | BPF_K,SECCOMP_RET_ALLOW), // return allow</span><br><span class="line">    &#125;;</span><br><span class="line">    // </span><br><span class="line">    struct sock_fprog prog = &#123;</span><br><span class="line">        .len = (unsigned short)(sizeof(filter)/sizeof(filter[0])),</span><br><span class="line">        .filter = filter,                                         </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    printf(&quot;set mode return %d\n&quot;,prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&amp;prog));</span><br><span class="line">    printf(&quot;seccomp change to mode filter\n&quot;);</span><br><span class="line"></span><br><span class="line">    // open should not work</span><br><span class="line">    int fd = syscall(__NR_open,&quot;flag.txt&quot;,O_RDONLY);</span><br><span class="line">    </span><br><span class="line">    // rest of the program wont execute</span><br><span class="line">    char flag[23];</span><br><span class="line">    read(fd,&amp;flag,23);</span><br><span class="line">    write(1,&amp;flag,23);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hello world1!</span><br><span class="line">current mode 0, change to filter mode now...</span><br><span class="line">set mode return 0</span><br><span class="line">seccomp change to mode filter</span><br><span class="line">Bad system call</span><br></pre></td></tr></table></figure>

<p>We can see seccomp successfully stop <code>open</code> syscall from executing!</p>
<p>We can also validate our seccomp filter using a tool call <a target="_blank" rel="noopener" href="https://github.com/david942j/seccomp-tools">seccomp-tools</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">17:06:17 $ seccomp-tools dump ./seccomp_filter</span><br><span class="line">hello world1!</span><br><span class="line">current mode 0, change to filter mode now...</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x15 0x00 0x02 0x00000002  if (A != open) goto 0004</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x06 0x00 0x00 0x7ff00000  return TRACE</span><br><span class="line"> 0004: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>


<h1 id="Common-strategies-in-CTF"><a href="#Common-strategies-in-CTF" class="headerlink" title="Common strategies in CTF"></a>Common strategies in CTF</h1><p>Now lets try to bypass our seccomp restriction.</p>
<h2 id="Seccomp-with-no-x32-ABI-check"><a href="#Seccomp-with-no-x32-ABI-check" class="headerlink" title="Seccomp with no x32 ABI check"></a>Seccomp with no x32 ABI check</h2><p>Here is our code from previous example. (see <code>seccomp_filter_no_x32_abi_check.c</code>)</p>
<p><img data-src="/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_171915.jpg" alt="img"></p>
<p>Is there anyway we can bypass that? The answer is yes. Because we restricting <code>x64</code> syscall, <code>x32</code> syscalls are not limited!</p>
<p>We can still use x32 ABI syscalls</p>
<p>Therefore, if set x32 syscall flag bit for our syscall number, we can use our system call again!</p>
<p>We replace our syscall of open with <code>__NR_open|__X32_SYSCALL_BIT</code>.  </p>
<p><code>seccomp_filter_no_x32_abi_check_bypass.c</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl</span><br><span class="line">// only works for common syscalls</span><br><span class="line">// using x32 ABI to bypass :)</span><br><span class="line">// 0x2 | 0x40000000</span><br><span class="line">int fd = syscall(__NR_open|__X32_SYSCALL_BIT,&quot;flag.txt&quot;,O_RDONLY);</span><br><span class="line">printf(&quot;why open works????????????????\n&quot;);</span><br></pre></td></tr></table></figure>

<p>Execute our program again, we get the flag!</p>
<p><img data-src="/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_174020.jpg" alt="get_flag"></p>
<h2 id="Seccomp-with-no-arch-check"><a href="#Seccomp-with-no-arch-check" class="headerlink" title="Seccomp with no arch check"></a>Seccomp with no arch check</h2><p>To prevent user from calling x32 ABI calls, we add another restriction. Check if syscall number is larger than <code>0x40000000</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BPF_JUMP(BPF_JMP | BPF_JGE| BPF_K,__X32_SYSCALL_BIT,1,0),</span><br></pre></td></tr></table></figure>

<p><code>seccomp_filter_no_arch_check.c</code><br><img data-src="/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_174430.jpg" alt="img"></p>
<p>Output for seccomp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">17:48:35 $ seccomp-tools dump ./seccomp_filter_no_arch_check</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x35 0x01 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0003</span><br><span class="line"> 0002: 0x15 0x00 0x02 0x00000002  if (A != open) goto 0005</span><br><span class="line"> 0003: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0004: 0x06 0x00 0x00 0x7ff00000  return TRACE</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>

<p>Now, previous method wont work because if our syscall number is larger than 0x40000000, program will return Kill and stop executing.</p>
<p>But, in this example, our rule doesn&#39;t check syscall for <code>i386</code> architecture. We can use <code>retf</code> and return to 32 bit. Then, we can use syscall from <code>i386</code>.</p>
<p>Here is the shellcode we can use to return to i386 code execution.</p>
<ol>
<li>xor return address with 0x2300000000 to return to 32 bit</li>
<li>push return address to the stack</li>
<li>use retf</li>
</ol>
<p><img data-src="/images/ctf/a-brief-introduction-to-seccomp-and-how-to-bypass/2022-11-08_175806.jpg" alt="get_flag_2"></p>
<p>full exploit can be found in <code>seccomp_filter_no_arch_check_bypass.c</code></p>
<p>Result</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">17:57:59 $ ./seccomp_filter_no_arch_check_bypass</span><br><span class="line">hello world1!</span><br><span class="line">current mode 0, change to filter mode now...</span><br><span class="line">set mode return 0</span><br><span class="line">seccomp change to mode filter</span><br><span class="line">now you can&#x27;t use open lol</span><br><span class="line">flag&#123;here_is_the_flag&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><p>TBD</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Seccomp">https://en.wikipedia.org/wiki/Seccomp</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11480">https://xz.aliyun.com/t/11480</a></li>
<li><a target="_blank" rel="noopener" href="https://n132.github.io/2022/07/04/S2.html">https://n132.github.io/2022/07/04/S2.html</a></li>
<li><a target="_blank" rel="noopener" href="https://tripoloski1337.github.io/ctf/2021/07/12/bypassing-seccomp-prctl.html">https://tripoloski1337.github.io/ctf/2021/07/12/bypassing-seccomp-prctl.html</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.redrocket.club/2019/04/11/midnightsunctf-quals-2019-gissa2/">http://blog.redrocket.club/2019/04/11/midnightsunctf-quals-2019-gissa2/</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"># pwn</a>
              <a href="/tags/ctf/" rel="tag"># ctf</a>
              <a href="/tags/seccomp/" rel="tag"># seccomp</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/articles/diary/ri-ji-20221012/" rel="prev" title="[日记] 20221012">
                  <i class="fa fa-angle-left"></i> [日记] 20221012
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/articles/life/journey-to-csaw-final-2022/" rel="next" title="CSAW CTF 2022 决赛记">
                  CSAW CTF 2022 决赛记 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Aynakeya</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
