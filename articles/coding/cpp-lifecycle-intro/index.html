<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0-rc2">

  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/static/favicon/safari_pinned_tab.svg" color="#222">
  <link rel="manifest" href="/static/favicon/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.aynakeya.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":null,"post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInDown","sidebar":"fadeInDown"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="IntroductionProgrammer: Huh. I wonder where are my objects? C++: I don&#39;t know. Objects have their own lifecycles.  adapt from: &quot;Your characters also have their own lives.&quot; -by anonymous">
<meta property="og:type" content="article">
<meta property="og:title" content="C++ object lifecyle adventure">
<meta property="og:url" content="http://www.aynakeya.com/articles/coding/cpp-lifecycle-intro/index.html">
<meta property="og:site_name" content="Aynakeya&#39;s Blog">
<meta property="og:description" content="IntroductionProgrammer: Huh. I wonder where are my objects? C++: I don&#39;t know. Objects have their own lifecycles.  adapt from: &quot;Your characters also have their own lives.&quot; -by anonymous">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240617_095406.png">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240617_100218.png">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240617_100642.png">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/memoryLayoutC.jpg">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240617_140715.png">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240618_145039.png">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240620_135358.png">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240620_135850.png">
<meta property="og:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240620_141735.png">
<meta property="article:published_time" content="2024-06-17T01:46:54.000Z">
<meta property="article:modified_time" content="2024-06-17T01:46:54.000Z">
<meta property="article:author" content="Aynakeya">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="c++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.aynakeya.com/images/coding/cpp-lifecycle-intro/Screenshot_20240617_095406.png">


<link rel="canonical" href="http://www.aynakeya.com/articles/coding/cpp-lifecycle-intro/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://www.aynakeya.com/articles/coding/cpp-lifecycle-intro/","path":"articles/coding/cpp-lifecycle-intro/","title":"C++ object lifecyle adventure"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>C++ object lifecyle adventure | Aynakeya's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Aynakeya's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Kill My Emotion</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-house fa-fw"></i>Home</a></li><li class="menu-item menu-item-infosec"><a href="/categories/ctf" rel="section"><i class="fa fa-solid fa-code fa-fw"></i>InfoSec</a></li><li class="menu-item menu-item-coding"><a href="/categories/coding" rel="section"><i class="fa fa-solid fa-code fa-fw"></i>Coding</a></li><li class="menu-item menu-item-anime"><a href="/categories/anime" rel="section"><i class="fa fa-solid fa-film fa-fw"></i>Anime</a></li><li class="menu-item menu-item-novel"><a href="/categories/novel" rel="section"><i class="fa fa-solid fa-book-open fa-fw"></i>Novel</a></li><li class="menu-item menu-item-life"><a href="/categories/life" rel="section"><i class="fa fa-solid fa-book fa-fw"></i>Life</a></li><li class="menu-item menu-item-devops"><a href="/categories/devops" rel="section"><i class="fa fa-solid fa-terminal fa-fw"></i>DevOps</a></li><li class="menu-item menu-item-sceneseries"><a href="/scene-series" rel="section"><i class="fa fa-solid fa-book fa-fw"></i>SceneSeries</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-ctf-writeup"><a href="/ctf-writeup" rel="section"><i class="fa fa-book fa-fw"></i>CTF-writeup</a></li><li class="menu-item menu-item-bookmarks"><a href="/bookmarks" rel="section"><i class="fa fa-bookmark fa-fw"></i>Bookmarks</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-js-projects"><a href="/my-js-project" rel="section"><i class="fas fa-folder fa-fw"></i>Js-projects</a></li><li class="menu-item menu-item-frontpage"><a href="/" rel="section"><i class="fa fa-leaf fa-fw"></i>Frontpage</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Some-Exploration"><span class="nav-number">2.</span> <span class="nav-text">Some Exploration</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Let-s-go-throught-object-s-lifecycle"><span class="nav-number">3.</span> <span class="nav-text">Let&#39;s go throught object&#39;s lifecycle</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Stack-Objects"><span class="nav-number">3.1.</span> <span class="nav-text">Stack Objects</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Heap-Objects"><span class="nav-number">3.2.</span> <span class="nav-text">Heap Objects</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-number">4.</span> <span class="nav-text">Conclusion</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">5.</span> <span class="nav-text">Reference</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Source-Code"><span class="nav-number">6.</span> <span class="nav-text">Source Code</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#check-location-cpp"><span class="nav-number">6.1.</span> <span class="nav-text">check_location.cpp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#obj-on-heap-cpp"><span class="nav-number">6.2.</span> <span class="nav-text">obj_on_heap.cpp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#obj-on-stack-cpp"><span class="nav-number">6.3.</span> <span class="nav-text">obj_on_stack.cpp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Allocation-Tracker-Snippet"><span class="nav-number">6.4.</span> <span class="nav-text">Allocation Tracker Snippet</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Aynakeya"
      src="/static/intro/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Aynakeya</p>
  <div class="site-description" itemprop="description">my blog~</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives">
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags">
        <span class="site-state-item-count">88</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/aynakeya" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;aynakeya" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:aynakeya.official@gmail.com" title="E-Mail → mailto:aynakeya.official@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/10003632" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;10003632" rel="noopener me" target="_blank"><i class="fas fa-video fa-fw"></i>Bilibili</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.aynakeya.com/articles/coding/cpp-lifecycle-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/static/intro/images/avatar.jpg">
      <meta itemprop="name" content="Aynakeya">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aynakeya's Blog">
      <meta itemprop="description" content="my blog~">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="C++ object lifecyle adventure | Aynakeya's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          C++ object lifecyle adventure
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-17 09:46:54" itemprop="dateCreated datePublished" datetime="2024-06-17T09:46:54+08:00">2024-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Programmer: Huh. I wonder where are my objects?</p>
<p>C++: I don&#39;t know. Objects have their own lifecycles.</p>
<blockquote>
<p>adapt from: <em>&quot;Your characters also have their own lives.&quot;</em> -by anonymous genshin impact fans<br>original: <em>《角色也有自己的生活》</em></p>
</blockquote>
<p>c++ object, contructor, deconstructor, variable scope and lifecycles.</p>
<span id="more"></span>


<h1 id="Some-Exploration"><a href="#Some-Exploration" class="headerlink" title="Some Exploration"></a>Some Exploration</h1><p>Let&#39;s start with a simple example. What is wrong with this piece of code?</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">some_external_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * cstr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * cstr = std::<span class="built_in">string</span>(<span class="string">&quot;Hello, World!&quot;</span>).<span class="built_in">c_str</span>();</span><br><span class="line">    <span class="built_in">some_external_function</span>(cstr);</span><br><span class="line">    std::string secret_data = <span class="string">&quot;secret data&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; secret_data &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems like it compiles and runs correctly. Everything works properly!</p>
<p><img data-src="/images/coding/cpp-lifecycle-intro/Screenshot_20240617_095406.png" alt="asd"></p>
<p>Or does it?</p>
<p>If we add another piece of code and print out the pointer, it is supposed to contain &quot;Hello world.&quot;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">some_external_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * cstr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * cstr = std::<span class="built_in">string</span>( <span class="string">&quot;Hello, World!&quot;</span>).<span class="built_in">c_str</span>();</span><br><span class="line">    <span class="built_in">some_external_function</span>(cstr);</span><br><span class="line">    std::string secret_data = <span class="string">&quot;secret data&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; secret_data &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; cstr &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Instead of printing &quot;Hello world,&quot; it actually prints out &quot;secret data.&quot;</p>
<p><img data-src="/images/coding/cpp-lifecycle-intro/Screenshot_20240617_100218.png" alt="Screenshot_20240617_100218.png"></p>
<p>Furthermore, if you are using a library built by malicious individuals, they can actually steal and modify your secrets.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cstring&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> * heheh = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">some_external_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * cstr)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;external function called with &#x27;%s&#x27;\n&quot;</span>, cstr);</span><br><span class="line">    heheh = (<span class="type">char</span> *)cstr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">some_evil_people</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;evil people got your secret &#x27;%s&#x27;\n&quot;</span>, heheh);</span><br><span class="line">    heheh[<span class="number">0</span>] = <span class="string">&#x27;H&#x27;</span>;</span><br><span class="line">    heheh[<span class="number">1</span>] = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line">    heheh[<span class="number">2</span>] = <span class="string">&#x27;h&#x27;</span>;</span><br><span class="line">    heheh[<span class="number">3</span>] = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line">    heheh[<span class="number">4</span>] = <span class="string">&#x27;h&#x27;</span>;</span><br><span class="line">    heheh[<span class="number">5</span>] = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">some_external_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * cstr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * cstr = std::<span class="built_in">string</span>( <span class="string">&quot;Hello, World!&quot;</span>).<span class="built_in">c_str</span>();</span><br><span class="line">    <span class="built_in">some_external_function</span>(cstr);</span><br><span class="line">    std::string secret_data = <span class="string">&quot;secret data&quot;</span>;</span><br><span class="line">    <span class="built_in">some_evil_people</span>();</span><br><span class="line">    std::cout &lt;&lt; secret_data &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/images/coding/cpp-lifecycle-intro/Screenshot_20240617_100642.png" alt="Screenshot_20240617_100642.png"></p>
<p>What&#39;s going on here?!?!</p>
<p>This is all because of C++&#39;s lifecycle.</p>
<h1 id="Let-s-go-throught-object-s-lifecycle"><a href="#Let-s-go-throught-object-s-lifecycle" class="headerlink" title="Let&#39;s go throught object&#39;s lifecycle"></a>Let&#39;s go throught object&#39;s lifecycle</h1><p>Before talking about an object&#39;s lifecycle, let&#39;s first find out where all my object data is.</p>
<p>So, as we all know, people on the internet always say the stack stores the local variables and stack frames, while the heap stores all malloced data.</p>
<p><img data-src="/images/coding/cpp-lifecycle-intro/memoryLayoutC.jpg" alt="memoryLayoutC.jpg"></p>
<blockquote>
<p>credit <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/memory-layout-of-c-program%3E">https://www.geeksforgeeks.org/memory-layout-of-c-program/</a></p>
</blockquote>
<p>Is it the same for C++ with all those complicated objects and class stuff? (Because objects are essentially structs with magic pointers and values.)</p>
<p>Not exactly.</p>
<p>Let&#39;s take a look at this program:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">init_heap_address</span>();</span><br><span class="line">    <span class="built_in">init_stack_address</span>();</span><br><span class="line">    std::string s1 = <span class="string">&quot;Hello! World!&quot;</span>;</span><br><span class="line">    std::string s2 = <span class="string">&quot;Heeeeeeeeeeeeeeeeeeeeeeeeeeeeeeello, World!&quot;</span>;</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s1&quot;</span>, (<span class="type">void</span> *)&amp;s1);</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s1 cstr&quot;</span>, (<span class="type">void</span> *)s1.<span class="built_in">data</span>());</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s2&quot;</span>, (<span class="type">void</span> *)&amp;s2);</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s2 cstr&quot;</span>, (<span class="type">void</span> *)s2.<span class="built_in">data</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can see that although the object itself is indeed on the stack (we can see both <code>s1</code> and <code>s2</code> addresses are on the stack), its internal data can be somewhere else, either in the stack (<code>s1.data</code>) or in the heap (<code>s2.data</code>).</p>
<p><img data-src="/images/coding/cpp-lifecycle-intro/Screenshot_20240617_140715.png" alt="re"></p>
<p>What&#39;s going on here? How can an object have its memory sometimes in the heap and sometimes in the stack?</p>
<p>This is because <code>std::string</code> is an object, and objects have <strong>constructors</strong>.</p>
<p>Like all other OOP languages, a constructor is called when an object is created.</p>
<p>Inside the constructor, a programmer can do whatever they want, like malloc a new memory or perform some calculations.</p>
<p>In the GCC implementation of <code>std::string</code>, there are two implementations of <code>std::string</code>. One is called a short string, and the other is called a long string.</p>
<p>Depending on the string length, if it&#39;s less than 23 characters, it allocates memory on the stack. Otherwise, it allocates new memory in the heap and puts the actual string content in the heap.</p>
<p>To verify this, we can add an allocation tracker to our program.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> * <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span> * mem = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[Allocation Tracker] allocating %ld bytes at %p\n&quot;</span>, size,mem);</span><br><span class="line">    <span class="keyword">return</span> mem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span> * mem)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[Allocation Tracker] free memory from %p&quot;</span>, mem);</span><br><span class="line">    <span class="built_in">free</span>(mem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">init_heap_address</span>();</span><br><span class="line">    <span class="built_in">init_stack_address</span>();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;init s1 string&quot;</span>);</span><br><span class="line">    std::string s1 = <span class="string">&quot;Hello! World!&quot;</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;init s2 string&quot;</span>);</span><br><span class="line">    std::string s2 = <span class="string">&quot;Heeeeeeeeeeeeeeeeeeeeeeeeeeeeeeello, World!&quot;</span>;</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s1&quot;</span>, (<span class="type">void</span> *)&amp;s1);</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s1 cstr&quot;</span>, (<span class="type">void</span> *)s1.<span class="built_in">data</span>());</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s2&quot;</span>, (<span class="type">void</span> *)&amp;s2);</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s2 cstr&quot;</span>, (<span class="type">void</span> *)s2.<span class="built_in">data</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Run the program again, and we can see the string object <code>malloc</code> and <code>free</code> new memory behind the scenes when the string length is long.</p>
<p><img data-src="/images/coding/cpp-lifecycle-intro/Screenshot_20240618_145039.png" alt="asdf"></p>
<p>But where does the program free the memory?</p>
<p>Here comes the <strong>destructor</strong>.</p>
<h2 id="Stack-Objects"><a href="#Stack-Objects" class="headerlink" title="Stack Objects"></a>Stack Objects</h2><p><strong>For objects inside the stack</strong>, the destructor will be called &quot;automatically&quot; when the variable goes out of scope. (There are also other cases where the destructor will be called!!!)</p>
<p>Let&#39;s see some examples.</p>
<p>Let&#39;s start with a class that tracks object construction and destruction.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Nanami</span>&#123;</span><br><span class="line">    std::string name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Nanami</span>(<span class="type">const</span> std::string&amp; name) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        std::cout &lt;&lt; name &lt;&lt;<span class="string">&quot;: owu I got created&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Nanami</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; name &lt;&lt;<span class="string">&quot;: owo I got destroyed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lol</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span>+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>For local variables, objects will be constructed when they are initialized and destructed when the function returns. Therefore, all allocated memory inside the object will be freed in the end, just like normal stack variables.</p>
<p><img data-src="/images/coding/cpp-lifecycle-intro/Screenshot_20240620_135358.png" alt="asd"></p>
<p>For objects inside a block, they act like local variables. When the program goes out of the block, the object calls the destructor and frees all the memory.</p>
<p><img data-src="/images/coding/cpp-lifecycle-intro/Screenshot_20240620_135850.png"></p>
<p>For xvalue scope, it calls the destructor when the statement finishes.</p>
<p><img data-src="/images/coding/cpp-lifecycle-intro/Screenshot_20240620_141735.png"></p>
<p>However, things are very different when you allocate <strong>objects on the heap</strong>.</p>
<h2 id="Heap-Objects"><a href="#Heap-Objects" class="headerlink" title="Heap Objects"></a>Heap Objects</h2><p>For objects on the heap, their lifecycle is fully controlled by the programmer. This means the object is constructed when the programmer uses <code>new</code> and destructed when the programmer uses <code>delete</code>.</p>
<p>The destructor only runs when <code>delete</code> is invoked.</p>
<p>So normally, if you create a new object and then delete it at the end, everything is fine.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">good_procedure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Nanami * mynanami = <span class="keyword">new</span> <span class="built_in">Nanami</span>(<span class="string">&quot;mynanami&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> mynanami;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But if your object goes out of scope and you no longer have access to it, it creates a dangling pointer and causes a memory leak in the program.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">block_memory_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Nanami * onheap = <span class="keyword">new</span> <span class="built_in">Nanami</span>(<span class="string">&quot;leak inside block&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In conclusion:</p>
<ol>
<li><p>Local (stack) objects, which are allocated within a function on the stack, have their lifetimes managed by the compiler. This means their destruction time is determined: when the program completes a certain code scope.</p>
</li>
<li><p>Heap objects, generally allocated via <code>new</code>, have lifetimes that differ from stack objects. Their lifetimes are fully controlled by the programmer, meaning manual control of the heap object&#39;s lifetime is required. Their destruction occurs when the corresponding <code>delete</code> is called.</p>
</li>
</ol>
<p>there is also another case I didn&#39;t mention, its object inside objects. Maybe I will cover it later. but for now, just stick with those two concepts.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://joellaity.com/2020/01/31/string.html">libc++&#39;s implementation of std::string</a></li>
<li><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/scope">cpp scopes</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/582674">消灭“脑细胞杀手”，阿里专家带你深入C++对象的生命周期管理</a></li>
<li><a target="_blank" rel="noopener" href="https://nihil.cc/posts/cpp_lvalue_rvalue/">[C++] 深入了解左值与右值</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liushui-sky/p/8004763.html">浅谈C++中对象的复制与对象之间的相互赋值</a></li>
</ul>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><h2 id="check-location-cpp"><a href="#check-location-cpp" class="headerlink" title="check_location.cpp"></a>check_location.cpp</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cstring&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_memory_mapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FILE * f = <span class="built_in">fopen</span>(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (f == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to open /proc/self/maps\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(buffer, <span class="number">1024</span>, f)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_self_address</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * name, <span class="type">void</span> **addr_start, <span class="type">void</span> **addr_end)</span> </span>&#123;</span><br><span class="line">    FILE *maps_file = <span class="built_in">fopen</span>(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!maps_file) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> line[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(line, <span class="built_in">sizeof</span>(line), maps_file)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, name)) &#123;</span><br><span class="line">            <span class="comment">// The line contains the stack segment</span></span><br><span class="line">            <span class="built_in">sscanf</span>(line, <span class="string">&quot;%p-%p&quot;</span>, addr_start, addr_end);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(maps_file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *stack_start, *stack_end;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_stack_address</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">get_self_address</span>(<span class="string">&quot;[stack]&quot;</span>, &amp;stack_start, &amp;stack_end);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack segment: %p-%p\n&quot;</span>, stack_start, stack_end);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_stack_address</span><span class="params">(<span class="type">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &gt;= stack_start &amp;&amp; addr &lt;= stack_end;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *heap_start, *heap_end;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_heap_address</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">get_self_address</span>(<span class="string">&quot;[heap]&quot;</span>, &amp;heap_start, &amp;heap_end);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Heap segment: %p-%p\n&quot;</span>, heap_start, heap_end);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_heap_address</span><span class="params">(<span class="type">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &gt;= heap_start &amp;&amp; addr &lt;= heap_end;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_address_location</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * name, <span class="type">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">is_stack_address</span>(addr)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s (%p) is in [stack]\n&quot;</span>,  name, addr);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">is_heap_address</span>(addr)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s (%p) is in [heap]\n&quot;</span>, name, addr);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s (%p) is in other segment\n&quot;</span>, name, addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">some_external_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * cstr)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//void * operator new(size_t size) &#123;</span></span><br><span class="line"><span class="comment">//    void * mem = malloc(size);</span></span><br><span class="line"><span class="comment">//    printf(&quot;[Allocation Tracker] allocating %ld bytes at %p\n&quot;, size,mem);</span></span><br><span class="line"><span class="comment">//    return mem;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//void operator delete(void * mem) &#123;</span></span><br><span class="line"><span class="comment">//    printf(&quot;[Allocation Tracker] free memory from %p\n&quot;, mem);</span></span><br><span class="line"><span class="comment">//    free(mem);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">init_heap_address</span>();</span><br><span class="line">    <span class="built_in">init_stack_address</span>();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;init s1 string&quot;</span>);</span><br><span class="line">    std::string s1 = <span class="string">&quot;Hello! World!&quot;</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;init s2 string&quot;</span>);</span><br><span class="line">    std::string s2 = <span class="string">&quot;Heeeeeeeeeeeeeeeeeeeeeeeeeeeeeeello, World!&quot;</span>;</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s1&quot;</span>, (<span class="type">void</span> *)&amp;s1);</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s1 cstr&quot;</span>, (<span class="type">void</span> *)s1.<span class="built_in">data</span>());</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s2&quot;</span>, (<span class="type">void</span> *)&amp;s2);</span><br><span class="line">    <span class="built_in">print_address_location</span>(<span class="string">&quot;s2 cstr&quot;</span>, (<span class="type">void</span> *)s2.<span class="built_in">data</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="obj-on-heap-cpp"><a href="#obj-on-heap-cpp" class="headerlink" title="obj_on_heap.cpp"></a>obj_on_heap.cpp</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Nanami</span>&#123;</span><br><span class="line">    std::string name;</span><br><span class="line">    <span class="type">void</span> * ptr;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Nanami</span>(<span class="type">const</span> std::string &amp; name) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        std::cout &lt;&lt; <span class="keyword">this</span>-&gt;name &lt;&lt;<span class="string">&quot;: owu I got created&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Nanami</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="keyword">this</span>-&gt;name &lt;&lt;<span class="string">&quot;: owo I got destroyed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lol</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">block_memory_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Nanami * onheap = <span class="keyword">new</span> <span class="built_in">Nanami</span>(<span class="string">&quot;leak inside block&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">good_procedure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Nanami * mynanami= <span class="keyword">new</span> <span class="built_in">Nanami</span>(<span class="string">&quot;mynanami&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> mynanami;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">good_procedure</span>();</span><br><span class="line">    <span class="built_in">block_memory_leak</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="obj-on-stack-cpp"><a href="#obj-on-stack-cpp" class="headerlink" title="obj_on_stack.cpp"></a>obj_on_stack.cpp</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Nanami</span>&#123;</span><br><span class="line">    std::string name;</span><br><span class="line">    <span class="type">void</span> * ptr;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Nanami</span>(<span class="type">const</span> std::string &amp; name) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        std::cout &lt;&lt; <span class="keyword">this</span>-&gt;name &lt;&lt;<span class="string">&quot;: owu I got created&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Nanami</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="keyword">this</span>-&gt;name &lt;&lt;<span class="string">&quot;: owo I got destroyed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lol</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span>+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">local_nanami_</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">Nanami <span class="title">lcl</span><span class="params">(<span class="string">&quot;local scope&quot;</span>)</span></span>;</span><br><span class="line">    lcl.<span class="built_in">lol</span>();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;before exit local&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">local_nanami</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; before local&quot;</span>);</span><br><span class="line">    <span class="built_in">local_nanami_</span>();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; after exit local&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">block_nanami</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; before block&quot;</span>);</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Nanami <span class="title">bls</span><span class="params">(<span class="string">&quot;block scope&quot;</span>)</span></span>;</span><br><span class="line">        bls.<span class="built_in">lol</span>();</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;before exit block&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; after exit block&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">temporary_nanami</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; before xvalue scope&quot;</span>);</span><br><span class="line">    <span class="type">int</span> val = <span class="built_in">Nanami</span>(<span class="string">&quot;xvalue scope&quot;</span>).<span class="built_in">lol</span>();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; after xvalue scope&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// todo: wtf????</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reassign_nanami</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; reconstruct_nanami&quot;</span>);</span><br><span class="line">    <span class="function">Nanami <span class="title">nanami</span><span class="params">(<span class="string">&quot;first initialization&quot;</span>)</span></span>;</span><br><span class="line">    nanami = <span class="built_in">Nanami</span>(<span class="string">&quot;second initialization&quot;</span>);</span><br><span class="line">    nanami.<span class="built_in">lol</span>();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; reconstruct_nanami&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">block_memory_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Nanami * onheap = <span class="keyword">new</span> <span class="built_in">Nanami</span>(<span class="string">&quot;leak inside bloc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Nanami <span class="title">glb</span><span class="params">(<span class="string">&quot;Global scope&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;enter main&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">local_nanami</span>();</span><br><span class="line">    <span class="built_in">block_nanami</span>();</span><br><span class="line">    <span class="built_in">temporary_nanami</span>();</span><br><span class="line"><span class="comment">//    reconstruct_nanami();</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">block_memory_leak</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;before exit main&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Allocation-Tracker-Snippet"><a href="#Allocation-Tracker-Snippet" class="headerlink" title="Allocation Tracker Snippet"></a>Allocation Tracker Snippet</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> * <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span> * mem = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[Allocation Tracker] allocating %ld bytes at %p\n&quot;</span>, size,mem);</span><br><span class="line">    <span class="keyword">return</span> mem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span> * mem)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[Allocation Tracker] free memory from %p&quot;</span>, mem);</span><br><span class="line">    <span class="built_in">free</span>(mem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ctf/" rel="tag"># ctf</a>
              <a href="/tags/c/" rel="tag"># c++</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/articles/coding/compile-opencv-tutorial/" rel="prev" title="在windows上编译并使用opencv的正确姿势">
                  <i class="fa fa-angle-left"></i> 在windows上编译并使用opencv的正确姿势
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Aynakeya</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
